---
phase: 14-undo-redo
plan: 02
type: execute
wave: 2
depends_on: [14-01]
files_modified: [examples/editor_demo.v]
autonomous: false

must_haves:
  truths:
    - "Cmd+Z undoes last edit (text reverts, cursor returns)"
    - "Cmd+Shift+Z redoes undone edit (text reappears)"
    - "Rapid typing coalesces into single undo operation"
    - "Navigation breaks coalescing (arrow keys, click)"
  artifacts:
    - path: "examples/editor_demo.v"
      provides: "Editor with working undo/redo"
      contains: ["UndoManager", "Cmd+Z", "Cmd+Shift+Z"]
  key_links:
    - from: "examples/editor_demo.v"
      to: "undo.v"
      via: "UndoManager usage"
      pattern: "undo_mgr\\.(record_mutation|undo|redo)"
---

<objective>
Integrate undo/redo into editor demo with Cmd+Z and Cmd+Shift+Z keyboard support.

Purpose: Complete UNDO-01 and UNDO-02 requirements by wiring UndoManager into the editor demo,
enabling users to actually use undo/redo functionality.

Output: Working editor demo with undo/redo support.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-undo-redo/14-RESEARCH.md
@.planning/phases/14-undo-redo/14-01-SUMMARY.md
@undo.v
@examples/editor_demo.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UndoManager to EditorState</name>
  <files>examples/editor_demo.v</files>
  <action>
Modify EditorState struct to include UndoManager:

1. Add import for undo module (already part of vglyph)

2. Add undo_mgr field to EditorState:
   ```v
   @[heap]
   struct EditorState {
   mut:
       // ... existing fields ...
       undo_mgr vglyph.UndoManager
   }
   ```

3. Initialize in main() or wherever EditorState is created:
   ```v
   state.undo_mgr = vglyph.new_undo_manager(100)  // 100 operation history
   ```
  </action>
  <verify>
`v fmt -w examples/editor_demo.v && v -check-syntax examples/editor_demo.v` passes
  </verify>
  <done>
EditorState has undo_mgr field initialized with 100 operation history limit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire mutation tracking and keyboard handlers</name>
  <files>examples/editor_demo.v</files>
  <action>
Update event handlers to track mutations and handle undo/redo:

1. **Track mutations** - After each mutation operation, call record_mutation:
   ```v
   // Example for character insertion:
   cursor_before := state.cursor_idx
   anchor_before := state.anchor_idx
   result := vglyph.insert_text(state.text, state.cursor_idx, char_str)
   state.text = result.new_text
   state.cursor_idx = result.cursor_pos
   // Track for undo
   state.undo_mgr.record_mutation(result, char_str, cursor_before, anchor_before)
   ```

2. **Wire all mutation sites:**
   - Character insertion (.char event)
   - Backspace deletion (.backspace)
   - Forward delete (.delete)
   - Word/line deletion (Option+Backspace, Cmd+Backspace, etc.)
   - Selection replacement (typing with selection)
   - Cut operation (Cmd+X)
   - Paste operation (Cmd+V)

3. **Add Cmd+Z handler** in key_down event:
   ```v
   if cmd_held && e.key_code == .z && !shift_held {
       if new_text, new_cursor, new_anchor := state.undo_mgr.undo(state.text,
                                                                  state.cursor_idx,
                                                                  state.anchor_idx) {
           state.text = new_text
           state.cursor_idx = new_cursor
           state.anchor_idx = new_anchor
           state.has_selection = (new_cursor != new_anchor)
           // Regenerate layout
           state.layout = state.ts.layout_text(state.text, state.cfg) or { return }
       }
       return
   }
   ```

4. **Add Cmd+Shift+Z handler** (redo):
   ```v
   if cmd_held && e.key_code == .z && shift_held {
       if new_text, new_cursor, new_anchor := state.undo_mgr.redo(state.text,
                                                                  state.cursor_idx,
                                                                  state.anchor_idx) {
           state.text = new_text
           state.cursor_idx = new_cursor
           state.anchor_idx = new_anchor
           state.has_selection = (new_cursor != new_anchor)
           // Regenerate layout
           state.layout = state.ts.layout_text(state.text, state.cfg) or { return }
       }
       return
   }
   ```

5. **Break coalescing on navigation:**
   - Call `state.undo_mgr.break_coalescing()` before:
     - Arrow key movement
     - Mouse click (position change)
     - Home/End keys
     - Cmd+Arrow (word/line movement)
  </action>
  <verify>
`v fmt -w examples/editor_demo.v && v -check-syntax examples/editor_demo.v` passes
`v examples/editor_demo.v -o /tmp/editor_demo` builds successfully
  </verify>
  <done>
All mutation sites track operations, Cmd+Z undoes, Cmd+Shift+Z redoes, navigation breaks coalescing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Editor demo with undo/redo support:
- Cmd+Z undoes last edit
- Cmd+Shift+Z redoes undone edit
- Rapid typing coalesces into single undo
- Navigation breaks coalescing
  </what-built>
  <how-to-verify>
1. Run: `v run examples/editor_demo.v`
2. Type "hello world" (continuous typing)
3. Press Cmd+Z once - entire "hello world" should disappear (coalesced)
4. Press Cmd+Shift+Z - "hello world" should reappear
5. Type "abc", press left arrow, type "xyz"
6. Press Cmd+Z - only "xyz" should undo (navigation broke coalescing)
7. Press Cmd+Z again - "abc" should undo
8. Do 5+ undo/redo cycles to verify consistency
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `v fmt -w examples/editor_demo.v` - formatting passes
2. `v -check-syntax examples/editor_demo.v` - no syntax errors
3. `v examples/editor_demo.v -o /tmp/editor_demo` - builds successfully
4. Manual test: Cmd+Z undoes, Cmd+Shift+Z redoes
5. Manual test: rapid typing coalesces
6. Manual test: navigation breaks coalescing
</verification>

<success_criteria>
- EditorState includes UndoManager with 100 operation limit
- All mutation sites call record_mutation
- Cmd+Z triggers undo, restores text and cursor
- Cmd+Shift+Z triggers redo, reapplies operation
- Navigation (arrows, click, home/end) breaks coalescing
- Rapid typing (within 1s) coalesces into single undo operation
- Demo builds and runs successfully
</success_criteria>

<output>
After completion, create `.planning/phases/14-undo-redo/14-02-SUMMARY.md`
</output>
