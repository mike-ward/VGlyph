---
phase: 36-integration-testing
plan: 02
type: execute
wave: 2
depends_on:
  - 36-01
files_modified:
  - _api_test.v
autonomous: true
must_haves:
  truths:
    - "API tests use real Pango Context instead of nil mocks"
    - "Input validation (invalid UTF-8) is verified against real backend logic"
    - "Cache key consistency is verified with real Context objects"
  artifacts:
    - path: "_api_test.v"
      provides: "Updated API test suite"
      contains: "new_context"
---

<objective>
Refactor `_api_test.v` to replace `unsafe { nil }` mocks with real `Context` instances.
This upgrades unit tests to integration tests where appropriate, ensuring that API-level checks (like input validation) work correctly when backed by a real C library.

Purpose: Eliminate fragile nil-pointer tests in favor of realistic interactions.
Output: Updated `_api_test.v` with passing tests.
</objective>

<context>
@_api_test.v
@api.v
@_integration_test.v
</context>

<tasks>

<task type="auto">
  <name>Replace Mocks in API Tests</name>
  <files>_api_test.v</files>
  <action>
    Identify tests in `_api_test.v` using `TextSystem` with `unsafe { nil }` for `ctx`.
    Update these tests to initialize a real `Context` using `new_context(1.0)!` and pass it to a `TextSystem` instance.
    The `renderer` can remain `unsafe { nil }` as long as `draw_text` is not called, as most `TextSystem` logic (width, height, layout) only depends on `ctx`.
  </action>
  <verify>v _api_test.v</verify>
  <done>Mocks replaced with real contexts in _api_test.v.</done>
</task>

<task type="auto">
  <name>Verify Input Validation with Real Backend</name>
  <files>_api_test.v</files>
  <action>
    Ensure tests like `test_api_layout_text_invalid_utf8` and `test_api_layout_text_too_long` are still effective when using a real `Context`.
    Verify that the `TextSystem` correctly propagates errors from both its internal validators and the underlying `Context` methods.
  </action>
  <verify>v _api_test.v</verify>
  <done>Validation tests pass with real context.</done>
</task>

</tasks>

<verification>
Run `v _api_test.v` and ensure all tests pass.
Run `v test .` to ensure full suite passes.
</verification>

<success_criteria>
- `_api_test.v` no longer relies on `unsafe { nil }` for `Context`.
- `TextSystem` methods (layout, measurements) are tested with real Pango interactions.
- All tests remain CI-compatible (headless).
</success_criteria>

<output>
After completion, create `.planning/phases/36-integration-testing/36-02-SUMMARY.md`
</output>
