---
phase: 36-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - _integration_test.v
autonomous: true
must_haves:
  truths:
    - "Integration tests run in headless mode (CI compatible)"
    - "Real Pango/FreeType backend is initialized in tests"
    - "Rich text layout (multiple runs) is verified against Pango logic"
    - "Vertical layout dimensions are verified"
  artifacts:
    - path: "_integration_test.v"
      provides: "Integration test suite"
      contains: "new_context"
  key_links:
    - from: "_integration_test.v"
      to: "new_context"
      via: "function call"
---

<objective>
Implement a dedicated integration test suite (`_integration_test.v`) that verifies core layout logic using the real Pango/FreeType backend instead of mocks.
This ensures the C-bindings and layout algorithms work correctly in a realistic environment.

Purpose: Validate "C-binding and layout logic integrity" as requested.
Output: A new `_integration_test.v` file with passing tests.
</objective>

<context>
@context.v
@layout.v
@api.v
</context>

<tasks>

<task type="auto">
  <name>Create Integration Test Suite</name>
  <files>_integration_test.v</files>
  <action>
    Create `_integration_test.v` with helper functions to initialize a real `Context`.
    Include `test_layout_lifecycle` to verify `new_context` and `free` work correctly in a test environment.
    Use `assert` to verify context is not nil and can load a default font (e.g. "Sans").
  </action>
  <verify>v _integration_test.v</verify>
  <done>Test file exists and lifecycle test passes.</done>
</task>

<task type="auto">
  <name>Implement Core Layout Tests</name>
  <files>_integration_test.v</files>
  <action>
    Add tests for:
    - **Basic Layout:** `layout_text` with simple ASCII and UTF-8 strings. Verify item count, width > 0.
    - **Rich Text:** `layout_rich_text` with multiple `StyleRun`s (e.g., "Hello" (Red) + "World" (Blue)). Verify items have correct colors/styles.
    - **Vertical Layout:** `layout_text` with `orientation: .vertical`. Verify `visual_height > visual_width` for stacked text.
  </action>
  <verify>v _integration_test.v</verify>
  <done>Tests for basic, rich, and vertical layout pass using real backend.</done>
</task>

<task type="auto">
  <name>Implement Hit Testing Tests</name>
  <files>_integration_test.v</files>
  <action>
    Add tests for `hit_test` and `get_cursor_pos` using real layout data.
    - Verify `hit_test` returns correct index for coordinates within a glyph.
    - Verify `get_cursor_pos` returns reasonable rects for start/end of text.
    - Test with multi-byte characters to ensure byte vs char index mapping is correct (Pango is byte-based, V is byte-based, but cursors often logical).
  </action>
  <verify>v _integration_test.v</verify>
  <done>Hit testing verification passes with real layout data.</done>
</task>

</tasks>

<verification>
Run `v _integration_test.v` and ensure all tests pass without requiring a window/GPU.
</verification>

<success_criteria>
- `_integration_test.v` exists and compiles.
- Real `Context` is used (no `unsafe { nil }` for Context).
- Layout logic (wrapping, rich text, vertical) is exercised against the C library.
</success_criteria>

<output>
After completion, create `.planning/phases/36-integration-testing/36-01-SUMMARY.md`
</output>
