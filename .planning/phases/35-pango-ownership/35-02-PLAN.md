---
phase: 35-pango-ownership
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified: [context.v, layout_attributes.v]
autonomous: true
must_haves:
  truths:
    - "Context struct uses PangoContext and PangoFontMap wrappers"
    - "Context.free() simplified to call wrapper free methods"
    - "layout_attributes.v uses PangoFontDescription wrapper for local cleanup"
    - "Attribute list creation in layout_attributes.v uses new_pango_attr_list()"
  artifacts:
    - path: "context.v"
    - path: "layout_attributes.v"
---

<objective>
Refactor `context.v` and `layout_attributes.v` to use the new Pango wrappers, ensuring safer memory management for contexts, font maps, and attribute lists.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@pango_wrappers.v
@context.v
@layout_attributes.v
</context>

<tasks>

<task type="auto">
  <name>Refactor context.v</name>
  <files>context.v</files>
  <action>
    - Change `Context.pango_font_map` type from `&C.PangoFontMap` to `PangoFontMap`.
    - Change `Context.pango_context` type from `&C.PangoContext` to `PangoContext`.
    - Update `new_context()` to initialize these fields using the wrappers.
    - Update `Context.free()` to call `.free()` on the wrappers.
    - In `font_height`, `font_metrics`, `resolve_font_name`, and `resolve_font_alias`, use `PangoFontDescription` and `PangoFont` wrappers for local variables that need cleanup.
    - Replace `defer { C.pango_font_description_free(desc) }` with `defer { desc.free() }`.
    - Update `create_font_description` to return `PangoFontDescription` wrapper.
  </action>
  <verify>
    Verify `Context` tests still pass.
  </verify>
  <done>
    Context is fully refactored to use wrappers.
  </done>
</task>

<task type="auto">
  <name>Refactor layout_attributes.v</name>
  <files>layout_attributes.v</files>
  <action>
    - In `apply_rich_text_style`, use `PangoFontDescription` wrapper for the `desc` variable.
    - Ensure `desc.free()` is called via defer.
    - Check for other Pango pointer usages and wrap them if they are owned locally.
  </action>
  <verify>
    Verify compilation.
  </verify>
  <done>
    Attribute management uses wrappers where appropriate.
  </done>
</task>

</tasks>

<success_criteria>
- `Context` manages its Pango resources through wrappers.
- No manual `g_object_unref` or `pango_font_description_free` calls remain in `context.v`.
- Code compiles and tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/35-pango-ownership/35-02-SUMMARY.md`
</output>
