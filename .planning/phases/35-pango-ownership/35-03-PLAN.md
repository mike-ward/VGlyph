---
phase: 35-pango-ownership
plan: 03
type: execute
wave: 3
depends_on: ["35-02"]
files_modified: [layout_pango.v, layout.v, layout_iter.v]
autonomous: true
must_haves:
  truths:
    - "setup_pango_layout returns PangoLayout wrapper"
    - "layout.v uses PangoLayout wrapper and calls .free() via defer"
    - "layout_iter.v uses PangoLayoutIter wrapper for safe iteration cleanup"
    - "Manual layout unref and iter free calls are removed"
  artifacts:
    - path: "layout_pango.v"
    - path: "layout.v"
    - path: "layout_iter.v"
---

<objective>
Refactor `PangoLayout` and `PangoLayoutIter` management across the layout engine to use RAII wrappers, eliminating manual cleanup blocks.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@pango_wrappers.v
@layout_pango.v
@layout.v
@layout_iter.v
</context>

<tasks>

<task type="auto">
  <name>Refactor layout_pango.v</name>
  <files>layout_pango.v</files>
  <action>
    - Change `setup_pango_layout` return type to `!PangoLayout`.
    - Wrap the created `layout` in `PangoLayout{ptr: layout}`.
    - Use `PangoFontDescription`, `PangoAttrList`, and `PangoTabArray` wrappers for local variables.
    - Replace `C.pango_attr_list_unref(attr_list)` with `attr_list.free()`.
    - Replace `C.pango_tab_array_free(tab_array)` with `tab_array.free()`.
    - Replace `C.pango_font_description_free(desc)` with `desc.free()`.
  </action>
  <verify>
    Verify compilation.
  </verify>
  <done>
    layout_pango.v uses wrappers for all owned Pango objects.
  </done>
</task>

<task type="auto">
  <name>Refactor layout.v and layout_iter.v</name>
  <files>layout.v, layout_iter.v</files>
  <action>
    - In `layout.v`, update `layout_text` to receive `PangoLayout` wrapper from `setup_pango_layout`.
    - Replace `defer { C.g_object_unref(layout) }` with `defer { layout.free() }`.
    - Use `PangoLayoutIter` wrapper for layout iterators.
    - Replace `defer { C.pango_layout_iter_free(iter) }` with `defer { iter.free() }`.
    - Apply similar changes to `layout_iter.v`.
  </action>
  <verify>
    Verify all layout tests pass.
  </verify>
  <done>
    Layout engine uses wrappers for layout and iterator management.
  </done>
</task>

</tasks>

<success_criteria>
- No manual `g_object_unref` or `pango_layout_iter_free` calls in the layout engine.
- Layout tests pass without regressions.
- Code is cleaner and more resistant to leaks.
</success_criteria>

<output>
After completion, create `.planning/phases/35-pango-ownership/35-03-SUMMARY.md`
</output>
