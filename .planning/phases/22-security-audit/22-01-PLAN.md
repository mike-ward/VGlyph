---
phase: 22-security-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/vglyph/api.v
  - src/vglyph/context.v
  - src/vglyph/layout.v
  - src/vglyph/validation.v
  - src/vglyph/_validation_test.v
autonomous: true

must_haves:
  truths:
    - "Malformed UTF-8 text returns descriptive error"
    - "Text exceeding length limit returns error"
    - "Invalid font paths return error"
    - "Extreme numeric values (0, negative, MAX_INT) return error or clamp safely"
  artifacts:
    - path: "validation.v"
      provides: "Centralized input validation functions"
      exports: ["validate_text_input", "validate_font_path", "validate_numeric_bounds"]
    - path: "_validation_test.v"
      provides: "Tests proving validation catches invalid input"
      contains: "test_invalid_utf8"
  key_links:
    - from: "api.v"
      to: "validation.v"
      via: "validate_text_input call at API boundary"
      pattern: "validate_text_input"
    - from: "context.v"
      to: "validation.v"
      via: "validate_font_path call"
      pattern: "validate_font_path"
---

<objective>
Add input validation layer to all public API entry points for text, paths, and numeric parameters.

Purpose: Satisfy SEC-01 (text validation), SEC-02 (path sanitization), SEC-03 (numeric bounds) per
CONTEXT.md decisions: reject invalid UTF-8, reject null/empty strings, existence-check paths, DoS
limits.

Output: validation.v module with centralized validators, validation calls in api.v/context.v/layout.v,
tests proving each validation catches bad input.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-security-audit/22-CONTEXT.md
@.planning/phases/22-security-audit/22-RESEARCH.md

# Source files to modify
@api.v
@context.v
@layout.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation module with text, path, numeric validators</name>
  <files>validation.v, _validation_test.v</files>
  <action>
Create validation.v with these functions:

1. `validate_text_input(text string, max_len int, location string) !string`
   - Use `import encoding.utf8.validate`
   - Return error if `!utf8.validate.utf8_string(text)` with "Invalid UTF-8 at ${@FILE}:${@LINE}"
   - Return error if `text.len == 0` with "Empty string not allowed"
   - Return error if `text.len > max_len` with "Text exceeds max length ${max_len}"
   - Default max_len: 10KB (10240 bytes) per RESEARCH.md recommendation
   - Return text unchanged if valid

2. `validate_font_path(path string, location string) !string`
   - Return error if path is empty
   - Return error if path contains ".." (path traversal)
   - Use `os.exists(path)` to check file exists
   - Let FreeType handle format validation per CONTEXT.md decision
   - Return path if valid

3. `validate_size(size f32, min f32, max f32, name string, location string) !f32`
   - Return error if size < min or size > max
   - Defaults: min=0.1, max=500 (font size)
   - Include name in error: "${name} ${size} out of range [${min}, ${max}]"
   - Return size if valid

4. `validate_dimension(dim int, name string, location string) !int`
   - Return error if dim <= 0
   - Return error if dim > 16384 (max texture dimension)
   - Return dim if valid

Create _validation_test.v with tests:
- test_validate_text_valid: normal UTF-8 passes
- test_validate_text_invalid_utf8: malformed bytes rejected
- test_validate_text_empty: empty string rejected
- test_validate_text_too_long: exceeds limit rejected
- test_validate_path_traversal: ".." rejected
- test_validate_path_nonexistent: missing file rejected
- test_validate_size_bounds: out of range rejected
- test_validate_dimension_zero: zero rejected
  </action>
  <verify>
`v test _validation_test.v` passes all tests.
`v -check-syntax validation.v` reports no errors.
  </verify>
  <done>
validation.v exports all validator functions. Tests prove invalid UTF-8, empty strings, path
traversal, and out-of-bounds values are rejected with descriptive errors including file:line.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire validators into public API entry points</name>
  <files>api.v, context.v, layout.v</files>
  <action>
Add validation calls at API boundaries. Per CONTEXT.md: return error on invalid input.

1. **api.v** - TextSystem public methods:
   - `draw_text()`: Add `validate_text_input(text, 10240, 'draw_text')!` at start
   - `text_width()`: Add same validation
   - `text_height()`: Add same validation
   - `layout_text()`: Add same validation
   - `layout_text_cached()`: Add same validation
   - `layout_rich_text()`: Validate each run's text in loop

2. **context.v** - Context public methods:
   - `add_font_file()`: Add `validate_font_path(path, 'add_font_file')!` at start
     - Change return type from `bool` to `!bool` to propagate errors
   - `create_font_description()`: Add `validate_size(style.size, 0.1, 500, 'font size', @FN)` if size > 0
   - `new_context()`: Validate scale_factor > 0 (already done, verify)

3. **layout.v** - layout_text and layout_rich_text:
   - Already covered by api.v wiring, but add defensive check in `layout_text()`:
     `validate_text_input(text, 10240, 'layout_text')!`
   - `layout_rich_text()`: Validate each run text in the loop

4. For numeric parameters that should clamp instead of error (per CONTEXT.md "Claude's discretion"):
   - Font size: clamp to [0.1, 500] with log.warn
   - Atlas dimensions: error (too important to silently clamp)
   - Scale factor: already clamped to 1.0 if invalid (keep existing behavior)

Update error messages to include `${@FILE}:${@LINE}` per RESEARCH.md pattern.
  </action>
  <verify>
`v -check-syntax api.v context.v layout.v` passes.
Create a quick test in _api_test.v that passes invalid UTF-8 to draw_text and confirms error returned.
  </verify>
  <done>
All public API entry points validate input before processing. Invalid UTF-8 returns descriptive
error. Empty strings rejected. Font paths checked for existence. Numeric bounds enforced.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for API-level validation</name>
  <files>_api_test.v</files>
  <action>
Add tests to existing _api_test.v that verify end-to-end validation:

1. `test_draw_text_invalid_utf8`:
   - Create TextSystem
   - Call draw_text with invalid UTF-8 bytes: `[u8(0xff), 0xfe]`
   - Assert returns error containing "Invalid UTF-8"

2. `test_draw_text_empty_string`:
   - Call draw_text with ""
   - Assert returns error containing "Empty string"

3. `test_add_font_file_nonexistent`:
   - Call add_font_file with "/nonexistent/path/font.ttf"
   - Assert returns error (not false, actual error)

4. `test_layout_text_too_long`:
   - Create string > 10KB
   - Call layout_text
   - Assert returns error containing "exceeds max"

5. `test_draw_text_valid`:
   - Verify normal text still works after adding validation
   - Call draw_text with "Hello World"
   - Assert no error

Note: Some tests may need mock gg.Context. If _api_test.v already has setup patterns, follow them.
If not possible to test without full graphics context, mark as $if !test { ... } conditional.
  </action>
  <verify>
`v test _api_test.v` passes.
  </verify>
  <done>
Integration tests prove API-level validation rejects bad input while accepting valid input.
  </done>
</task>

</tasks>

<verification>
1. `v test .` - all tests pass including new validation tests
2. `v -check-syntax *.v` - no syntax errors
3. Grep for validate_ calls in api.v/context.v/layout.v confirms wiring complete
4. Error messages include file:line location
</verification>

<success_criteria>
1. Malformed UTF-8 text passed to draw_text returns error with "Invalid UTF-8" and byte position
2. Empty strings passed to any text API return error with "Empty string not allowed"
3. Nonexistent font paths return error (not silent false)
4. Text > 10KB returns error with "exceeds max"
5. All existing tests still pass (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/22-security-audit/22-01-SUMMARY.md`
</output>
