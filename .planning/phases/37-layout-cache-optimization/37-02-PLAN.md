---
phase: 37-layout-cache-optimization
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - api.v
autonomous: true
must_haves:
  truths:
    - "get_cache_key implementation is optimized"
    - "Layout cache hit rate remains consistent or improves"
    - "stress_demo.v runs correctly with optimized hashing"
  artifacts:
    - path: "api.v"
      contains: "get_cache_key"
---

<objective>
Optimize layout cache key generation.
Purpose: Reduce CPU overhead of hashing strings and struct fields on every draw call.
Output: Refactored get_cache_key with better performance characteristics.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@api.v
@.planning/phases/37-layout-cache-optimization/37-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Optimize get_cache_key in api.v</name>
  <files>api.v</files>
  <action>
    1. Implement string hash caching for font names:
       - Add `font_hash_cache map[string]u64` to `TextSystem`.
       - In `get_cache_key`, use the cached hash for `cfg.style.font_name` if available, otherwise compute and cache it.
    2. Reduce FNV calls by packing scalar fields:
       - Combine `typeface`, `underline`, `strikethrough`, `use_markup`, `no_hit_testing`, `align`, `wrap` into a single `u64` before hashing.
    3. Optimize hashing of common fields (color, size) by combining them if possible.
    4. Ensure `fnv_hash_string` is only called once for the primary `text`.
    5. Implement "Granular caching" logic:
       - Hash `TextStyle` and `BlockStyle` separately if they are reused (though currently they are part of `TextConfig`).
       - For now, focus on optimizing the hashing of the existing structure.
  </action>
  <verify>
    v -d profile run examples/stress_demo.v
    Check console for "Layout: ... us" and compare with Plan 01 baseline.
    v test _api_test.v (Ensure no regression in hash consistency)
  </verify>
  <done>
    get_cache_key is refactored and verified faster or less resource-intensive.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final verification and cleanup</name>
  <files>api.v, examples/stress_demo.v</files>
  <action>
    1. Verify `prune_cache` logic still works correctly with optimized keys.
    2. Perform a final run of `stress_demo.v` to ensure stability.
    3. (Optional) Remove the periodic printing from `stress_demo.v` if it's too noisy, or leave it as a diagnostic feature behind `-d profile`.
  </action>
  <verify>
    v run examples/stress_demo.v
    v test .
  </verify>
  <done>
    Phase 37 optimizations verified and stable.
  </done>
</task>

</tasks>

<verification>
Run all tests and stress demo. Verify that cache hit rate is still high and performance is stable.
</verification>

<success_criteria>
- get_cache_key uses cached hashes for font names.
- Field packing reduces number of hashing steps.
- All existing tests in `_api_test.v` pass.
</success_criteria>

<output>
After completion, create `.planning/phases/37-layout-cache-optimization/37-02-SUMMARY.md`
</output>
