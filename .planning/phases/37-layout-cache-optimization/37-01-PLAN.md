---
phase: 37-layout-cache-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - context.v
  - api.v
  - examples/stress_demo.v
autonomous: true
must_haves:
  truths:
    - "ProfileMetrics tracks layout cache size and evictions"
    - "print_summary outputs cache size and eviction count"
    - "stress_demo.v prints profile summary on exit or periodically"
  artifacts:
    - path: "context.v"
      contains: "layout_cache_size"
    - path: "api.v"
      contains: "ts.eviction_count++"
---

<objective>
Implement telemetry for layout cache optimization.
Purpose: Enable measurement of cache size and evictions to verify optimization impact.
Output: Updated ProfileMetrics and TextSystem with new counters.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@context.v
@api.v
@examples/stress_demo.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ProfileMetrics in context.v</name>
  <files>context.v</files>
  <action>
    1. Add `layout_cache_size int` and `layout_cache_evictions int` to `ProfileMetrics` struct (inside `$if profile ?` block).
    2. Update `print_summary()` to include these new metrics:
       - Show eviction count in Layout Cache line.
       - Show cache size (count of items).
  </action>
  <verify>
    grep "layout_cache_size" context.v
    grep "layout_cache_evictions" context.v
  </verify>
  <done>
    ProfileMetrics struct has new fields and print_summary outputs them.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TextSystem telemetry in api.v</name>
  <files>api.v</files>
  <action>
    1. Add `eviction_count int` to `TextSystem` struct (private field).
    2. In `prune_cache()`, increment `ts.eviction_count` when deleting items.
    3. In `get_profile_metrics()`, populate:
       - `layout_cache_size` from `ts.cache.len`.
       - `layout_cache_evictions` from `ts.eviction_count`.
    4. In `reset_profile_metrics()`, reset `ts.eviction_count = 0`.
  </action>
  <verify>
    grep "eviction_count" api.v
    grep "ts.cache.len" api.v
  </verify>
  <done>
    TextSystem tracks evictions and reports them via get_profile_metrics.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update stress_demo.v for verification</name>
  <files>examples/stress_demo.v</files>
  <action>
    1. Import `vglyph` (already imported).
    2. In `frame()` function, add a check: if `app.frame_count % 600 == 0` (every ~10s), call `app.ts.get_profile_metrics().print_summary()`.
    3. Ensure this is wrapped in `$if profile ?` or handled gracefully if metrics are empty.
    Note: ProfileMetrics methods are only available with `-d profile`.
  </action>
  <verify>
    v -d profile run examples/stress_demo.v
    (Should compile and print summary after 10s)
  </verify>
  <done>
    stress_demo.v outputs profiling data when run with -d profile.
  </done>
</task>

</tasks>

<verification>
Run `v -d profile run examples/stress_demo.v` and observe console output for new metrics.
</verification>

<success_criteria>
- ProfileMetrics contains layout_cache_size and layout_cache_evictions.
- TextSystem correctly tracks evictions.
- print_summary output includes "Layout Cache: ... X evictions, size Y".
</success_criteria>

<output>
After completion, create `.planning/phases/37-layout-cache-optimization/37-01-SUMMARY.md`
</output>
