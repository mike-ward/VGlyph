---
phase: 23-code-consistency
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - api.v
  - renderer.v
  - glyph_atlas.v
  - layout.v
autonomous: true

must_haves:
  truths:
    - "Library code uses panic only for debug assertions and truly unrecoverable states"
    - "Error messages are lowercase without trailing punctuation"
    - "Fallible functions use ! return type"
  artifacts:
    - path: "api.v"
      provides: "API with proper error handling"
      contains: "pub fn"
    - path: "renderer.v"
      provides: "Renderer with init panic documented"
      contains: "new_renderer"
    - path: "layout.v"
      provides: "Layout with debug-only assertions"
      contains: "$if debug"
  key_links:
    - from: "pub fn"
      to: "error()"
      via: "! return type"
      pattern: "pub fn.*!"
---

<objective>
Audit panic usage and error handling consistency in library code.

Purpose: CON-06 requirement - ensure error handling follows V idioms (! returns, or blocks).
Panics should only exist for debug assertions or truly unrecoverable states.

Output: All panics justified/documented, error messages lowercase, fallible functions use !.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-code-consistency/23-CONTEXT.md
@.planning/phases/23-code-consistency/23-RESEARCH.md
@.planning/phases/23-code-consistency/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and document panic usage in library code</name>
  <files>api.v, renderer.v, glyph_atlas.v, layout.v</files>
  <action>
Review each panic in library files and categorize:

**Current panics (11 total):**

1. **layout.v:44** - `AttrList leak` - debug-only ($if debug), keep as-is
2. **layout.v:248** - `iterator reused after exhaustion` - debug-only, keep as-is
3. **layout.v:258** - `PangoLayoutRun cast returned nil` - debug-only, keep as-is
4. **layout.v:933** - `char iterator reused after exhaustion` - debug-only, keep as-is
5. **api.v:316** - `unreachable` - map access after contains check, add comment
6. **renderer.v:45** - `panic(err)` at init - atlas creation unrecoverable, add comment
7. **renderer.v:69** - `panic(err)` at init - atlas creation unrecoverable, add comment
8. **renderer.v:325** - `unreachable` - map access after contains check, add comment
9. **renderer.v:331** - `cache collision` - debug-only detection, add $if debug guard
10. **glyph_atlas.v:260** - `FT_Outline_Translate` - programming error, add debug guard
11. **glyph_atlas.v:278** - `FT_Render_Glyph` - programming error, add debug guard

**Actions:**
- Verify all debug-only panics are inside `$if debug { }` blocks
- Add `$if debug { }` guard around glyph_atlas panics (programming errors)
- Add comments explaining why init panics are acceptable in renderer.v
- Add `// unreachable: map access after 'key in cache' check` comments

Do NOT convert to error returns if:
- Inside `$if debug { }` (development-time assertions)
- At initialization where failure is unrecoverable
- After contains check (logically impossible to reach)
  </action>
  <verify>
All panics in library code have one of:
- `$if debug { }` guard (debug assertions)
- `// init failure unrecoverable` comment
- `// unreachable:` comment explaining why
  </verify>
  <done>All panics documented with clear justification</done>
</task>

<task type="auto">
  <name>Task 2: Verify error message conventions</name>
  <files>*.v, accessibility/*.v</files>
  <action>
Audit all error() calls for V conventions:

**Requirements:**
1. Lowercase first letter (unless proper noun/path)
2. No trailing period
3. Descriptive but terse

**Check command:**
```bash
rg "error\('" *.v accessibility/*.v
```

**Known patterns to verify:**
- `return error('message')` - lowercase, no period
- Interpolated errors with ${} - ok to have uppercase in interpolated values

**Fix any violations:**
- `error('Failed to...')` -> `error('failed to...')` (lowercase)
- `error('Something.')` -> `error('something')` (no period)

**Exception:** Error messages from Phase 22 security audit intentionally include
location info like `${@FILE}:${@LINE}` - these are acceptable.
  </action>
  <verify>
```bash
# No capitalized error messages (excluding interpolation)
rg "error\('[A-Z]" *.v accessibility/*.v | grep -v '\${' | wc -l  # Should be 0
# No trailing periods (excluding ..)
rg "error\('.*[^.]\.\)" *.v accessibility/*.v | wc -l  # Should be 0
```
  </verify>
  <done>All error messages follow V convention (lowercase, no trailing punctuation)</done>
</task>

<task type="auto">
  <name>Task 3: Verify ! return types on fallible functions</name>
  <files>*.v, accessibility/*.v</files>
  <action>
Audit public functions that can fail to ensure they use ! return type:

**Already correct patterns:**
- `pub fn new_context(...) !&Context`
- `pub fn (mut ts TextSystem) draw_text(...) !`
- `pub fn validate_text(...) !`

**Check for potential issues:**
```bash
# Find pub fn that contain error() but don't have ! in signature
rg -l 'error\(' *.v | xargs -I{} sh -c 'rg "^pub fn" {} | grep -v "!"'
```

Most should already be correct from Phase 22 security audit.
Verify no new functions were added without proper error types.

**Note:** Functions returning `?Type` (optional) for "not found" are also correct:
- `pub fn hit_test_rect(...) ?gg.Rect` - returns none if no hit
  </action>
  <verify>
Every `pub fn` that contains `return error(` has `!` in its return type
  </verify>
  <done>CON-06 satisfied - all fallible functions use proper V error idioms</done>
</task>

</tasks>

<verification>
```bash
# All panics documented
rg 'panic\(' *.v accessibility/*.v  # Each should have comment or $if debug

# Error messages lowercase
rg "error\('[A-Z]" *.v accessibility/*.v | grep -v '\${' | wc -l  # 0

# Fallible functions have !
# (manual check - ensure error() only in ! functions)
```
</verification>

<success_criteria>
- [ ] All library panics have documentation or $if debug guard
- [ ] All error messages lowercase, no trailing punctuation
- [ ] All pub fn with error() have ! return type
</success_criteria>

<output>
After completion, create `.planning/phases/23-code-consistency/23-02-SUMMARY.md`
</output>
