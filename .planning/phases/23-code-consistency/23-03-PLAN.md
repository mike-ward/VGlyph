---
phase: 23-code-consistency
plan: 03
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - api.v
  - c_bindings.v
  - context.v
  - glyph_atlas.v
  - renderer.v
  - accessibility/manager.v
  - accessibility/objc_bindings_darwin.v
autonomous: true

must_haves:
  truths:
    - "All pub fn have doc comments"
    - "Function names use snake_case"
    - "Type names use PascalCase"
    - "Test files follow _*_test.v naming"
  artifacts:
    - path: "api.v"
      provides: "Fully documented public API"
      contains: "// "
    - path: "renderer.v"
      provides: "Documented renderer functions"
      contains: "// "
  key_links:
    - from: "pub fn"
      to: "// comment"
      via: "preceding line"
      pattern: "//.*\npub fn"
---

<objective>
Ensure all public functions have doc comments and naming follows V conventions.

Purpose: CON-01 through CON-05 and CON-07 - naming consistency, doc comments, test naming,
struct organization.

Output: 100% doc comment coverage on pub fn, verified naming conventions.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/23-code-consistency/23-CONTEXT.md
@.planning/phases/23-code-consistency/23-RESEARCH.md
@.planning/phases/23-code-consistency/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add missing doc comments to pub fn</name>
  <files>
    - api.v (1 missing)
    - c_bindings.v (2 missing)
    - context.v (2 missing)
    - glyph_atlas.v (1 missing)
    - renderer.v (3 missing)
    - accessibility/announcer.v (1 missing)
    - accessibility/manager.v (2 missing)
    - accessibility/objc_bindings_darwin.v (5 missing)
  </files>
  <action>
Add doc comments to all pub fn missing them. Current coverage: 131/148 (89%).

**Doc comment format (V convention):**
```v
// function_name does X with Y.
// Additional details if needed.
//
// Returns error if:
// - condition A
// - condition B
pub fn function_name(...) ! {
```

**Guidelines from CONTEXT.md:**
- Comment starts with function name in lowercase
- Terse description, present tense
- "Returns error if:" section for ! functions
- No verbose javadoc-style boilerplate

**For each missing comment:**
1. Read the function to understand purpose
2. Write 1-2 sentence description
3. Add error conditions if ! return type
4. Format as `// function_name does X.`

**C bindings (c_bindings.v):** May be internal helpers - if truly private/internal,
can use shorter comments. If pub, document what the binding provides.

**Obj-C bindings (objc_bindings_darwin.v):** Platform-specific, document the macOS
API being wrapped and any caveats.
  </action>
  <verify>
```bash
# Check doc comment coverage - should be 148/148
for f in *.v accessibility/*.v; do
  awk '/^\/\// { has_comment = 1 }
       /^pub fn/ { if (!has_comment) print FILENAME":"NR": missing doc"; has_comment = 0 }
       /^[^\/]/ && !/^pub fn/ { has_comment = 0 }' "$f"
done
```
  </verify>
  <done>All 148 pub fn have doc comments</done>
</task>

<task type="auto">
  <name>Task 2: Verify naming conventions</name>
  <files>*.v, accessibility/*.v</files>
  <action>
Audit naming conventions match V style guide:

**Functions (CON-01):** snake_case
```bash
# Should return no matches (PascalCase function names are violations)
rg '^(pub )?fn [A-Z]' *.v accessibility/*.v
```

**Variables (CON-02):** snake_case
```bash
# Spot check - variables should be snake_case
# No automated check needed, V compiler would catch camelCase
```

**Types (CON-03):** PascalCase
```bash
# Should return no matches (snake_case struct names are violations)
rg '^(pub )?struct [a-z]' *.v accessibility/*.v
```

**Test files (CON-05):** Must end in _test.v
```bash
# All test files should match pattern
ls *test*.v  # Should all be _*_test.v format
```

**Struct organization (CON-07):** Fields grouped logically
- Verify major structs (TextSystem, Context, Layout, Renderer) have sensible field grouping
- Check for `pub:` vs `pub mut:` separation
- No action needed if already organized (from codebase analysis, they are)

Report any violations found.
  </action>
  <verify>
```bash
rg '^(pub )?fn [A-Z]' *.v accessibility/*.v | wc -l  # 0
rg '^(pub )?struct [a-z]' *.v accessibility/*.v | wc -l  # 0
ls _*_test.v  # All test files match pattern
```
  </verify>
  <done>CON-01, CON-02, CON-03, CON-05, CON-07 verified - naming conventions consistent</done>
</task>

<task type="auto">
  <name>Task 3: Final consistency verification</name>
  <files>*.v, accessibility/*.v</files>
  <action>
Run comprehensive verification of all CON-* requirements:

**CON-01 (Function naming):** Verified in Task 2
**CON-02 (Variable naming):** snake_case enforced by convention
**CON-03 (Type naming):** Verified in Task 2
**CON-04 (Module partitioning):** Already well-organized per codebase analysis
**CON-05 (Test files):** Verified in Task 2
**CON-06 (Error handling):** Handled in Plan 02
**CON-07 (Struct organization):** Verified in Task 2
**CON-08 (v fmt):** Handled in Plan 01
**CON-09 (Line length):** Handled in Plan 01

Create summary checklist for phase verification:
```
CON-01: Functions snake_case - PASS
CON-02: Variables snake_case - PASS
CON-03: Types PascalCase - PASS
CON-04: Modules logical - PASS (existing structure)
CON-05: Test files _*_test.v - PASS
CON-06: Error handling V idioms - PASS (Plan 02)
CON-07: Struct organization - PASS
CON-08: v fmt compliance - PASS (Plan 01)
CON-09: Lines <= 99 chars - PASS (Plan 01)
```
  </action>
  <verify>All CON-* requirements pass verification</verify>
  <done>Phase 23 requirements CON-01 through CON-09 all satisfied</done>
</task>

</tasks>

<verification>
```bash
# Doc comments complete
for f in *.v accessibility/*.v; do
  awk '/^pub fn/ { count++; if (!prev_comment) missing++ }
       /^\/\// { prev_comment = 1; next }
       { prev_comment = 0 }
       END { if (missing > 0) print FILENAME": "missing" pub fn without doc comments" }' "$f"
done

# Naming conventions
rg '^(pub )?fn [A-Z]' *.v accessibility/*.v  # Empty
rg '^(pub )?struct [a-z]' *.v accessibility/*.v  # Empty

# Test files
ls _*_test.v  # All match pattern
```
</verification>

<success_criteria>
- [ ] All pub fn have doc comments (148/148)
- [ ] No PascalCase function names
- [ ] No snake_case type names
- [ ] All test files follow _*_test.v pattern
- [ ] Struct fields logically organized
</success_criteria>

<output>
After completion, create `.planning/phases/23-code-consistency/23-03-SUMMARY.md`
</output>
