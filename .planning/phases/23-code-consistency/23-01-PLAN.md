---
phase: 23-code-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - "*.v"
  - "accessibility/*.v"
autonomous: true

must_haves:
  truths:
    - "All source files pass v fmt -verify"
    - "No source lines exceed 99 characters"
  artifacts:
    - path: "*.v"
      provides: "Formatted V source"
      contains: "module vglyph"
    - path: "accessibility/*.v"
      provides: "Formatted accessibility module"
      contains: "module accessibility"
  key_links:
    - from: "v fmt"
      to: "all .v files"
      via: "recursive formatting"
      pattern: "v fmt -w"
---

<objective>
Fix formatting compliance and line length violations across all V source files.

Purpose: CON-08 and CON-09 requirements - ensure codebase passes automated format checks and
respects 99-char line limit (per project CLAUDE.md).

Output: All .v files pass `v fmt -verify` and have no lines >99 chars.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/23-code-consistency/23-CONTEXT.md
@.planning/phases/23-code-consistency/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run v fmt and verify formatting compliance</name>
  <files>*.v, accessibility/*.v</files>
  <action>
Run `v fmt -w` on all V files in root and accessibility/ directories.
Then run `v fmt -verify` to confirm no further changes needed.
If verify fails, re-run fmt and check for issues.

Note: v fmt wraps at 100 chars but project requires 99. Format first, then address line length.
  </action>
  <verify>`v fmt -verify *.v accessibility/*.v` exits 0</verify>
  <done>All V files pass v fmt -verify with no output</done>
</task>

<task type="auto">
  <name>Task 2: Fix lines exceeding 99 characters</name>
  <files>
    - _text_height_test.v (2 lines)
    - api.v (2 lines)
    - c_bindings.v (4 lines)
    - composition.v (1 line)
    - context.v (5 lines)
    - glyph_atlas.v (6 lines)
    - layout_accessibility.v (1 line)
    - layout_mutation.v (1 line)
    - layout.v (6 lines)
  </files>
  <action>
For each file with lines >99 chars, wrap or split the long lines:

**Strategy by line type:**
1. **Error messages** (most common): Use string concatenation or extract variable
   ```v
   // Before (120 chars):
   return error('Bitmap copy out of bounds: pos(${x},${y}) size(...) page(...)')
   // After (split):
   msg := 'bitmap copy out of bounds: pos(${x},${y}) size(${w}x${h})'
   return error(msg)
   ```

2. **Panic messages**: Same as errors - extract to variable or split string

3. **Doc comments**: Rewrap at 99 chars maintaining semantic integrity

4. **Long parameter lists**: Already handled by v fmt, but if still >99, use trailing comma style

5. **C binding declarations**: Split across lines using V's line continuation

**48 lines identified** - manually review each and apply minimal wrapping changes.
Do NOT change logic or behavior. Only formatting for line length.
  </action>
  <verify>`awk 'length > 99' *.v accessibility/*.v | wc -l` returns 0</verify>
  <done>No V source lines exceed 99 characters</done>
</task>

<task type="auto">
  <name>Task 3: Final verification and format check</name>
  <files>*.v, accessibility/*.v</files>
  <action>
1. Run `v fmt -w *.v accessibility/*.v` again after line length fixes
2. Run `v fmt -verify *.v accessibility/*.v` to confirm compliance
3. Run `v -check-syntax *.v accessibility/*.v` to ensure no syntax errors introduced
4. Run `awk 'length > 99'` to confirm no lines exceed limit

If any step fails, fix and re-run until all pass.
  </action>
  <verify>
All commands pass:
- `v fmt -verify *.v accessibility/*.v` exits 0
- `v -check-syntax *.v accessibility/*.v` exits 0
- `awk 'length > 99' *.v accessibility/*.v | wc -l` returns 0
  </verify>
  <done>CON-08 and CON-09 requirements satisfied - formatting compliant, lines under 99 chars</done>
</task>

</tasks>

<verification>
```bash
# CON-08: Format compliance
v fmt -verify *.v accessibility/*.v

# CON-09: Line length
awk 'length > 99' *.v accessibility/*.v | wc -l  # Should be 0

# Syntax check (no regressions)
v -check-syntax *.v accessibility/*.v
```
</verification>

<success_criteria>
- [ ] `v fmt -verify` passes on all source files
- [ ] No source lines exceed 99 characters
- [ ] `v -check-syntax` passes (no syntax errors introduced)
</success_criteria>

<output>
After completion, create `.planning/phases/23-code-consistency/23-01-SUMMARY.md`
</output>
