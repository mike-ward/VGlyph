---
phase: 04-layout-iteration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/layout.v
autonomous: true

must_haves:
  truths:
    - "Iterator lifecycle documented inline at creation sites"
    - "Exhausted iterator reuse caught in debug builds"
    - "defer cleanup already present (no new work)"
  artifacts:
    - path: "layout.v"
      provides: "Iterator lifecycle documentation and exhaustion guards"
      contains: "Iterator lifecycle:"
  key_links:
    - from: "build_layout_from_pango"
      to: "pango_layout_iter_free"
      via: "defer block"
      pattern: "defer.*pango_layout_iter_free"
---

<objective>
Add iterator lifecycle documentation and exhaustion guards to layout.v

Purpose: Prevent undefined behavior from iterator misuse (ITER-01, ITER-02, ITER-03)
Output: Hardened iterator usage with inline docs and debug-only guards
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-layout-iteration/04-RESEARCH.md
@layout.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add iterator lifecycle documentation</name>
  <files>layout.v</files>
  <action>
Add inline lifecycle documentation comment block at each iterator creation site.
There are 3 sites:

1. build_layout_from_pango (line ~108):
   Before `iter := C.pango_layout_get_iter(layout)`, add:
   ```v
   // Iterator lifecycle:
   // 1. Create via pango_layout_get_iter (caller owns)
   // 2. Iterate with next_run/next_char/next_line until returns false
   // 3. DO NOT reuse after exhausted - create new iterator
   // 4. MUST free via pango_layout_iter_free (defer handles this)
   ```

2. compute_hit_test_rects (line ~733):
   Before `iter := C.pango_layout_get_iter(layout)`, add same comment block.

3. compute_lines (line ~803):
   Before `line_iter := C.pango_layout_get_iter(layout)`, add same comment block.
   Keep existing comment about why new iterator created (lines 800-802).

Format file after: `v fmt -w layout.v`
  </action>
  <verify>
    grep -c "Iterator lifecycle:" layout.v returns 3
    v fmt -w layout.v succeeds
  </verify>
  <done>All 3 iterator creation sites have lifecycle documentation</done>
</task>

<task type="auto">
  <name>Task 2: Add exhaustion guard to run iteration loop</name>
  <files>layout.v</files>
  <action>
In build_layout_from_pango, the run iteration loop (lines ~154-181) uses the iterator.
Add exhaustion tracking and debug guard.

1. After `defer { C.pango_layout_iter_free(iter) }` (line ~113), add:
   ```v
   mut iter_exhausted := false
   ```

2. At the START of the for loop body (line ~155), add debug check:
   ```v
   $if debug {
       if iter_exhausted {
           panic('layout iterator reused after exhaustion')
       }
   }
   ```

3. After `if !C.pango_layout_iter_next_run(iter)` returns false (line ~178-180):
   Change to:
   ```v
   if !C.pango_layout_iter_next_run(iter) {
       iter_exhausted = true
       break
   }
   ```

Format: `v fmt -w layout.v`
  </action>
  <verify>
    grep "iter_exhausted" layout.v shows variable and usage
    v -check-syntax layout.v passes
  </verify>
  <done>Run iteration loop has exhaustion guard (debug-only panic if reused)</done>
</task>

<task type="auto">
  <name>Task 3: Add exhaustion guard to char iteration loop</name>
  <files>layout.v</files>
  <action>
In compute_hit_test_rects, the char iteration loop (lines ~748-792) uses iterator.
Add exhaustion tracking same pattern as Task 2.

1. After `defer { C.pango_layout_iter_free(iter) }` (line ~737), add:
   ```v
   mut iter_exhausted := false
   ```

2. At START of for loop body (line ~749), add:
   ```v
   $if debug {
       if iter_exhausted {
           panic('char iterator reused after exhaustion')
       }
   }
   ```

3. After `if !C.pango_layout_iter_next_char(iter)` (line ~789-791):
   Change to:
   ```v
   if !C.pango_layout_iter_next_char(iter) {
       iter_exhausted = true
       break
   }
   ```

Format: `v fmt -w layout.v`
Syntax check: `v -check-syntax layout.v`
  </action>
  <verify>
    grep -c "iter_exhausted" layout.v returns 6 (2 per loop x 3 usages, but we only did 2 loops)
    v -check-syntax layout.v passes
  </verify>
  <done>Char iteration loop has exhaustion guard</done>
</task>

</tasks>

<verification>
- `v fmt -w layout.v` completes without error
- `v -check-syntax layout.v` passes
- `grep -c "Iterator lifecycle:" layout.v` returns 3
- `grep -c "iter_exhausted" layout.v` returns at least 4 (2 declarations + 2 checks + 2 sets)
</verification>

<success_criteria>
1. All 3 iterator creation sites have inline lifecycle documentation
2. Run and char iteration loops have exhaustion guards (debug-only)
3. Code compiles and passes syntax check
4. Existing defer cleanup patterns preserved (no changes to them)
</success_criteria>

<output>
After completion, create `.planning/phases/04-layout-iteration/04-01-SUMMARY.md`
</output>
