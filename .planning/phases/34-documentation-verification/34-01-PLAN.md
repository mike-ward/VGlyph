---
phase: 34-documentation-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/SECURITY.md
  - README.md
  - docs/IME-APPENDIX.md
  - docs/EDITING.md
  - docs/API.md
autonomous: true

must_haves:
  truths:
    - "SECURITY.md documents view hierarchy walk with trust boundary diagram"
    - "SECURITY.md limitation #4 (overlay API limitation) removed or updated"
    - "README.md shows overlay API as primary IME integration path with code example"
    - "IME-APPENDIX.md no longer says CJK IME is 'Future Work'"
    - "EDITING.md documents overlay callback registration pattern"
    - "API.md lists ime_overlay_* public functions"
  artifacts:
    - path: "docs/SECURITY.md"
      provides: "View hierarchy trust boundary section"
      contains: "NSView Hierarchy Discovery"
    - path: "README.md"
      provides: "Overlay API IME section"
      contains: "ime_overlay_create_auto"
    - path: "docs/IME-APPENDIX.md"
      provides: "CJK IME via overlay (current, not future)"
      contains: "Overlay API"
    - path: "docs/EDITING.md"
      provides: "Overlay callback registration"
      contains: "ime_overlay_register_callbacks"
    - path: "docs/API.md"
      provides: "IME overlay API reference"
      contains: "ime_overlay_create_auto"
  key_links:
    - from: "README.md"
      to: "docs/EDITING.md"
      via: "cross-reference link"
    - from: "docs/EDITING.md"
      to: "docs/IME-APPENDIX.md"
      via: "cross-reference link"
---

<objective>
Update all project documentation to reflect Phase 33's overlay API activation.
SECURITY.md gets view hierarchy trust boundary section, README gets overlay as
primary IME path, IME-APPENDIX moves from "future" to "current," EDITING and
API docs add overlay function references.

Purpose: Requirement IME-05 — docs must reflect overlay API as shipped feature.
Output: 5 updated documentation files.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-overlay-api-wiring/33-01-SUMMARY.md
@.planning/phases/33-overlay-api-wiring/33-02-SUMMARY.md
@.planning/phases/34-documentation-verification/34-RESEARCH.md
@docs/SECURITY.md
@README.md
@docs/IME-APPENDIX.md
@docs/EDITING.md
@docs/API.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SECURITY.md and README.md</name>
  <files>docs/SECURITY.md, README.md</files>
  <action>
**SECURITY.md changes:**

1. Add new section "## NSView Hierarchy Discovery (macOS Overlay API)" BEFORE
   "## Known Limitations". Content should document:
   - Overview: overlay API discovers MTKView by walking NSWindow's subview tree
   - Trust boundary diagram (ASCII art):
     ```
     [TRUSTED]              [BOUNDARY]            [VALIDATED]
     V application    -->   FFI call      -->     NSWindow view tree
     editor_demo.v          vglyph_discover_      Subviews checked via
                            mtkview_from_window() isKindOfClass
     ```
   - Implementation safety: NULL check on NSWindow, depth limit 100,
     isKindOfClass runtime type check, NULL return on not found
   - Failure handling: returns NULL (caller falls back to global callbacks),
     no exceptions, logs to stderr
   - Security properties: cannot crash, cannot be spoofed, fails safe,
     no privilege escalation
   - Known limitations: assumes MTKView present (sokol always creates one),
     does not validate subclass behavior

2. In "## Known Limitations", update item #4:
   - OLD: "Overlay API limitation" about gg not exposing MTKView handle
   - NEW: "Overlay API macOS-only" - overlay discovery requires NSWindow,
     non-macOS uses global callback fallback. Not a security issue.

**README.md changes:**

1. Add IME section after the "Features" list (before "Prerequisites").
   Use heading "## Input Method Editor (IME) Support". Content:
   - Brief intro: VGlyph supports CJK IME for Japanese, Chinese, Korean
   - macOS overlay API code example (v1.8+):
     ```v ignore
     $if darwin {
         ns_window := C.sapp_macos_get_window()
         ime_overlay := vglyph.ime_overlay_create_auto(ns_window)
         vglyph.ime_overlay_register_callbacks(ime_overlay, ...)
         vglyph.ime_overlay_set_focused_field(ime_overlay, 'field_id')
     }
     ```
   - Cross-platform global callbacks (v1.3+) brief mention
   - Links to EDITING.md and IME-APPENDIX.md
   - Known issue note: Korean first-keypress macOS bug

2. Update editor_demo bullet in Examples section to mention IME:
   "Interactive text editing with CJK IME support"

After edits, run `v check-md -w docs/SECURITY.md` and
`v check-md -w README.md` to verify markdown formatting.

Text lines must not exceed 99 characters (except preformatted).
  </action>
  <verify>
- `v check-md -w docs/SECURITY.md` passes
- `v check-md -w README.md` passes
- `grep -c "NSView Hierarchy Discovery" docs/SECURITY.md` returns 1
- `grep -c "ime_overlay_create_auto" README.md` returns at least 1
- No line in docs/SECURITY.md or README.md exceeds 99 chars
  (except inside code blocks)
  </verify>
  <done>
SECURITY.md has view hierarchy trust boundary section with diagram
and safety analysis. README.md shows overlay API as primary IME path
with code example. Old SECURITY.md limitation #4 updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update IME-APPENDIX.md, EDITING.md, API.md</name>
  <files>docs/IME-APPENDIX.md, docs/EDITING.md, docs/API.md</files>
  <action>
**IME-APPENDIX.md changes:**

1. Update "## Current State" / "### What Works" to add:
   - CJK IME composition (Japanese, Chinese, Korean) via overlay API
   - NSWindow -> MTKView auto-discovery
   - Per-overlay callbacks with multi-field support

2. Update "### What Doesn't Work Yet" to remove CJK IME items.
   Replace with:
   - Korean first-keypress requires refocus (macOS system bug,
     QTBUG-136128, Apple FB17460926, Alacritty #6942)
   - Linux/Windows IME (IBus, Fcitx, IMM32/TSF not implemented)

3. Rename "## Future Work: CJK IME" to
   "## CJK IME via Overlay API (v1.8+)".
   Rewrite section:
   - Remove "Current Limitation" and "Potential Solutions" (solved)
   - Keep "Infrastructure Ready" but reword as "Architecture":
     VGlyphIMEOverlayView (NSTextInputClient), auto-discovery from
     NSWindow, per-overlay callbacks, multi-field routing
   - Update "Testing CJK IME" to present tense (works now)
   - Keep "Platform Notes" as-is

4. Update Table of Contents to match new headings.

**EDITING.md changes:**

1. In "## IME API" section, add subsection
   "### Overlay API (macOS, v1.8+)" after "### Dead Keys (Working)".
   Content:
   - Brief explanation: overlay creates transparent NSView sibling
     above MTKView, receives IME events directly
   - Code example showing overlay lifecycle:
     ```v ignore
     // Create overlay (discovers MTKView automatically)
     ns_window := C.sapp_macos_get_window()
     overlay := vglyph.ime_overlay_create_auto(ns_window)

     // Register callbacks
     vglyph.ime_overlay_register_callbacks(overlay,
         on_marked_text_fn, on_insert_text_fn,
         on_do_command_fn, on_get_rect_fn,
         on_clause_fn, user_data)

     // Activate for a field
     vglyph.ime_overlay_set_focused_field(overlay, 'my_field')

     // Cleanup
     vglyph.ime_overlay_free(overlay)
     ```
   - Note: falls back to global callbacks if overlay creation fails

2. Update the cross-reference text in IME API intro from "future CJK
   plans" to "CJK IME details and overlay architecture".

**API.md changes:**

1. Add new section "## IME Overlay API" before the final
   "## Font Management" section. Content:

   - `ime_overlay_create_auto(ns_window voidptr) voidptr`
     Creates overlay by auto-discovering MTKView from NSWindow.
     Returns overlay handle or NULL on failure.

   - `ime_overlay_register_callbacks(handle, on_marked_text,
     on_insert_text, on_do_command, on_get_rect, on_clause,
     user_data)` Registers per-overlay IME callbacks.

   - `ime_overlay_set_focused_field(handle, field_id string)`
     Activates overlay for specific text field.

   - `ime_overlay_free(handle voidptr)`
     Destroys overlay and cancels any active composition.

   - `ime_discover_mtkview(ns_window voidptr) voidptr`
     Low-level: discovers MTKView from NSWindow view hierarchy.

   - Note: macOS only (`$if darwin`), stubs return NULL on other
     platforms.

After edits, run `v check-md -w` on all three files.
Text lines must not exceed 99 characters (except preformatted).
  </action>
  <verify>
- `v check-md -w docs/IME-APPENDIX.md` passes
- `v check-md -w docs/EDITING.md` passes
- `v check-md -w docs/API.md` passes
- `grep -c "Future Work" docs/IME-APPENDIX.md` returns 0
- `grep -c "Overlay API" docs/IME-APPENDIX.md` returns at least 1
- `grep -c "ime_overlay_register_callbacks" docs/EDITING.md` returns
  at least 1
- `grep -c "ime_overlay_create_auto" docs/API.md` returns at least 1
  </verify>
  <done>
IME-APPENDIX.md reflects overlay as shipped (not future). EDITING.md
documents overlay callback registration. API.md lists all
ime_overlay_* public functions.
  </done>
</task>

</tasks>

<verification>
All 5 documentation files updated and pass `v check-md -w`:
1. docs/SECURITY.md — view hierarchy trust boundary section present
2. README.md — overlay API as primary IME integration path
3. docs/IME-APPENDIX.md — CJK IME section says "current" not "future"
4. docs/EDITING.md — overlay callback registration documented
5. docs/API.md — ime_overlay_* functions listed
</verification>

<success_criteria>
- Zero references to overlay as "future work" or "not implemented"
  in any doc file
- SECURITY.md trust boundary section exists with diagram
- README.md has IME code example with ime_overlay_create_auto
- All 5 files pass `v check-md -w`
</success_criteria>

<output>
After completion, create
`.planning/phases/34-documentation-verification/34-01-SUMMARY.md`
</output>
