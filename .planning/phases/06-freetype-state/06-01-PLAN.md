---
phase: 06-freetype-state
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [glyph_atlas.v]
autonomous: true

must_haves:
  truths:
    - "load->translate->render sequence documented at each FT operation"
    - "Invalid state transitions panic in debug builds before FT call"
    - "Fallback path state transitions documented as valid alternative"
  artifacts:
    - path: "glyph_atlas.v"
      provides: "FT state validation and sequence documentation"
      contains: "Requires: glyph loaded"
  key_links:
    - from: "FT_Outline_Translate"
      to: "FT_Load_Glyph"
      via: "prerequisite check"
      pattern: "\\$if debug.*outline"
    - from: "FT_Render_Glyph"
      to: "glyph slot"
      via: "prerequisite check"
      pattern: "\\$if debug.*glyph"
---

<objective>
Add FreeType state validation and sequence documentation to glyph_atlas.v

Purpose: Catch invalid FT state transitions in debug builds before undefined behavior occurs
Output: Inline docs at each FT operation + debug-only prerequisite checks
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-freetype-state/06-CONTEXT.md
@.planning/phases/06-freetype-state/06-RESEARCH.md
@glyph_atlas.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document FT state sequence at each operation</name>
  <files>glyph_atlas.v</files>
  <action>
Add inline comments documenting state requirements at each FreeType operation in load_glyph():

1. Before FT_Load_Glyph (line ~148):
   ```v
   // State: load_glyph entry
   // Requires: valid face (from Pango), valid glyph index
   // Produces: glyph slot populated with outline or bitmap
   ```

2. Before FT_Outline_Translate (line ~176):
   ```v
   // State: outline loaded (NO_BITMAP flag used, no FT_LOAD_RENDER)
   // Requires: glyph.outline valid with n_points > 0
   // Produces: outline shifted by subpixel amount
   ```

3. Before FT_Render_Glyph (line ~186):
   ```v
   // State: outline loaded and translated
   // Requires: glyph slot contains outline data
   // Produces: glyph.bitmap populated
   ```

4. At fallback reload (lines ~187-190):
   ```v
   // Fallback: render failed (bitmap font or no outline)
   // State: resets to post-load with immediate render
   // Valid alternative path: FT_LOAD_RENDER produces bitmap directly
   ```

Keep comments minimal per project style: "Requires:" + brief description.
  </action>
  <verify>grep -n "Requires:" glyph_atlas.v shows 4+ documented sites</verify>
  <done>Each FT operation has inline state documentation</done>
</task>

<task type="auto">
  <name>Task 2: Add debug-only prerequisite checks</name>
  <files>glyph_atlas.v</files>
  <action>
Add debug-only validation before FT operations that have state prerequisites:

1. Before FT_Outline_Translate (after should_shift check succeeds):
   ```v
   $if debug {
       if glyph.outline.n_points == 0 {
           panic('FT_Outline_Translate requires loaded outline, got empty. Check FT_Load_Glyph flags.')
       }
   }
   ```
   Why: Catches if outline is empty (bitmap font loaded despite NO_BITMAP flag).

2. Before FT_Render_Glyph:
   ```v
   $if debug {
       if glyph == unsafe { nil } {
           panic('FT_Render_Glyph requires glyph slot. FT_Load_Glyph must succeed first.')
       }
   }
   ```
   Why: Catches if glyph slot somehow became invalid.

Do NOT add check before FT_Load_Glyph - face validity is Pango's responsibility.
Match Phase 4/5 panic style with descriptive message.
  </action>
  <verify>v -check-syntax glyph_atlas.v && grep -c '\$if debug' glyph_atlas.v shows increased count</verify>
  <done>Debug builds panic on invalid state transitions before FT calls</done>
</task>

<task type="auto">
  <name>Task 3: Document fallback path as valid state sequence</name>
  <files>glyph_atlas.v</files>
  <action>
Enhance the fallback path documentation to explicitly note it follows valid state invariants:

At the fallback reload block (lines ~187-191), update comments to:
```v
// Fallback path: FT_Render_Glyph failed
// This occurs for bitmap fonts where FT_LOAD_NO_BITMAP still loads bitmap data
// but outline.n_points == 0, making render fail.
//
// Valid state sequence: reload with FT_LOAD_RENDER
// - Resets glyph slot to fresh state
// - Produces bitmap directly (no translate/render step needed)
// - Same validity requirements as normal load: face + index valid
if C.FT_Load_Glyph(cfg.face, cfg.index, C.FT_LOAD_RENDER | C.FT_LOAD_COLOR | target_flag) != 0 {
    return error('FT_Render_Glyph failed and fallback load failed')
}
// glyph now has bitmap directly via FT_LOAD_RENDER
```

This documents that fallback is a valid alternative path, not a divergent/unsafe path.
  </action>
  <verify>grep -A5 "Fallback path" glyph_atlas.v shows state sequence explanation</verify>
  <done>Fallback path explicitly documented as valid state sequence</done>
</task>

</tasks>

<verification>
1. v -check-syntax glyph_atlas.v - no syntax errors
2. v fmt -verify glyph_atlas.v - formatting valid
3. grep -c "Requires:" glyph_atlas.v - shows 3+ documented prerequisites
4. grep -c '\$if debug' glyph_atlas.v - shows debug guards present
5. v test . - existing tests pass (no regressions)
</verification>

<success_criteria>
- FT-01: load->translate->render sequence documented inline at each FT operation
- FT-02: Debug checks catch invalid state before FT_Outline_Translate and FT_Render_Glyph
- FT-03: Fallback path documented as valid alternative (not state divergence)
- Zero release overhead (all validation in $if debug blocks)
</success_criteria>

<output>
After completion, create `.planning/phases/06-freetype-state/06-01-SUMMARY.md`
</output>
