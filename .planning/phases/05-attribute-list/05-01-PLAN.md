---
phase: 05-attribute-list
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [layout.v]
autonomous: true

must_haves:
  truths:
    - "Ownership rules documented at every AttrList creation and unref site"
    - "Double-free impossible via existing defer/unref pattern (verified, documented)"
    - "Leaked AttrLists detected in debug builds before undefined behavior"
  artifacts:
    - path: "layout.v"
      provides: "AttrList ownership documentation and debug leak tracking"
      contains: "AttrList lifecycle"
  key_links:
    - from: "layout.v:create_layout_with_runs"
      to: "pango_attr_list_unref"
      via: "ownership transfer after set_attributes"
      pattern: "pango_layout_set_attributes.*pango_attr_list_unref"
    - from: "layout.v:setup_pango_layout"
      to: "pango_attr_list_unref"
      via: "ownership transfer after set_attributes"
      pattern: "pango_layout_set_attributes.*pango_attr_list_unref"
---

<objective>
Document AttrList ownership and add debug leak detection to layout.v

Purpose: Make ownership boundaries explicit and catch leaks in debug builds (ATTR-01, ATTR-02,
ATTR-03)

Output: Ownership docs at creation/unref sites, debug-only leak counter
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-attribute-list/05-RESEARCH.md
@layout.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AttrList ownership documentation at all creation/unref sites</name>
  <files>layout.v</files>
  <action>
Add ownership lifecycle documentation at 4 sites in layout.v:

1. Lines ~82-98 (create_layout_with_runs):
   Before line 82 add comment block:
   ```
   // AttrList lifecycle:
   // 1. Copy existing (get_attributes returns layout-owned, don't unref) or create new
   // 2. Caller owns the copy/new list (refcount=1)
   // 3. Modify with pango_attr_list_insert (list takes ownership of attributes)
   // 4. set_attributes refs the list (layout holds its own ref)
   // 5. MUST unref caller's copy (pattern: set_attributes then unref)
   ```

2. Lines ~303-357 (setup_pango_layout):
   Before line 303 add same comment block as above.

3. Line ~868 (apply_rich_text_style function):
   Add doc comment at function start:
   ```
   // apply_rich_text_style modifies a caller-owned AttrList.
   // Caller retains ownership; this function only inserts attributes.
   // Attributes inserted become owned by the list (don't free them separately).
   ```

Match Phase 4 iterator documentation style (concise, inline, actionable).
  </action>
  <verify>grep "AttrList lifecycle" layout.v returns 2 matches; grep "Caller retains ownership"
  returns 1 match</verify>
  <done>Ownership boundaries documented at all 4 AttrList sites</done>
</task>

<task type="auto">
  <name>Task 2: Add debug-only AttrList leak counter</name>
  <files>layout.v</files>
  <action>
Add debug-only leak tracking matching Phase 4 exhaustion guard pattern:

1. Near top of file (after imports, before functions), add global counter:
   ```v
   $if debug {
       __global attr_list_alloc_count = int(0)
   }
   ```

2. Create helper functions for tracking:
   ```v
   // track_attr_list_alloc increments debug counter when AttrList created.
   fn track_attr_list_alloc() {
       $if debug {
           __global attr_list_alloc_count++
       }
   }

   // track_attr_list_free decrements debug counter when AttrList freed.
   fn track_attr_list_free() {
       $if debug {
           __global attr_list_alloc_count--
       }
   }

   // check_attr_list_leaks panics if any AttrLists leaked. Call at shutdown.
   pub fn check_attr_list_leaks() {
       $if debug {
           if __global attr_list_alloc_count != 0 {
               panic('AttrList leak: ${__global attr_list_alloc_count} list(s) not freed')
           }
       }
   }
   ```

3. Add tracking calls at the 4 allocation/free sites:
   - After line ~86 (pango_attr_list_copy): add track_attr_list_alloc()
   - After line ~88 (pango_attr_list_new): add track_attr_list_alloc()
   - Before line ~98 (pango_attr_list_unref): add track_attr_list_free()
   - After line ~307 (pango_attr_list_copy): add track_attr_list_alloc()
   - After line ~309 (pango_attr_list_new): add track_attr_list_alloc()
   - Before line ~357 (pango_attr_list_unref): add track_attr_list_free()

Zero runtime overhead in release builds (all wrapped in $if debug).
  </action>
  <verify>v fmt -w layout.v && v -check-syntax layout.v passes; grep "attr_list_alloc_count"
  layout.v returns matches</verify>
  <done>Debug-only leak counter tracks all AttrList allocations</done>
</task>

<task type="auto">
  <name>Task 3: Verify double-free protection and document in code</name>
  <files>layout.v</files>
  <action>
Verify existing pattern prevents double-free and add explicit documentation:

1. At each unref site (lines ~98 and ~357), add inline comment:
   ```v
   // Double-free prevented: unref called exactly once after set_attributes.
   // V has no move semantics, but our pattern (create -> modify -> set -> unref)
   // ensures single ownership path. set_attributes refs the list, we release ours.
   ```

2. Review: apply_rich_text_style receives list by reference but doesn't free.
   Verify the function signature shows &C.PangoAttrList (borrowed, not owned).
   Add comment at call sites in create_layout_with_runs if helpful.

The existing defer-less pattern (explicit unref after set_attributes) is correct.
Document WHY it's safe for future maintainers.
  </action>
  <verify>grep "Double-free prevented" layout.v returns 2 matches</verify>
  <done>Double-free protection verified and documented</done>
</task>

</tasks>

<verification>
- v fmt -w layout.v passes
- v -check-syntax layout.v passes
- grep "AttrList lifecycle" layout.v shows 2 matches
- grep "attr_list_alloc_count" layout.v shows matches
- grep "Double-free prevented" layout.v shows 2 matches
- grep "check_attr_list_leaks" layout.v shows public function
</verification>

<success_criteria>
- ATTR-01: Ownership boundaries documented at all AttrList creation/unref sites
- ATTR-02: Double-free protection verified and documented (existing pattern is safe)
- ATTR-03: Debug-only leak counter tracks allocations, check_attr_list_leaks() available
</success_criteria>

<output>
After completion, create `.planning/phases/05-attribute-list/05-01-SUMMARY.md`
</output>
