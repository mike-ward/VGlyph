---
phase: 18-overlay-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ime_overlay_darwin.m
  - ime_overlay_darwin.h
  - ime_overlay_stub.c
  - c_bindings.v
autonomous: true

must_haves:
  truths:
    - "VGlyphIMEOverlayView class exists and implements NSTextInputClient protocol methods"
    - "Overlay positioned as sibling above MTKView (not child)"
    - "Clicks pass through overlay to MTKView underneath"
    - "Overlay becomes first responder when vglyph_set_focused_field called with non-NULL"
    - "Overlay resigns first responder when vglyph_set_focused_field called with NULL"
    - "Non-Darwin builds compile and link successfully"
  artifacts:
    - path: "ime_overlay_darwin.m"
      provides: "VGlyphIMEOverlayView class + factory + focus API"
      contains: "VGlyphIMEOverlayView"
    - path: "ime_overlay_darwin.h"
      provides: "C header for overlay API"
      exports: ["vglyph_create_ime_overlay", "vglyph_set_focused_field", "vglyph_overlay_free"]
    - path: "ime_overlay_stub.c"
      provides: "No-op implementations for non-Darwin"
      contains: "vglyph_create_ime_overlay"
    - path: "c_bindings.v"
      provides: "V bindings for overlay API"
      contains: "ime_overlay"
  key_links:
    - from: "c_bindings.v"
      to: "ime_overlay_darwin.h"
      via: "#include directive"
      pattern: '#include.*ime_overlay'
    - from: "ime_overlay_darwin.m"
      to: "NSWindow makeFirstResponder:"
      via: "first responder management"
      pattern: "makeFirstResponder"
---

<objective>
Create transparent NSView overlay that receives CJK IME events via NSTextInputClient protocol.

Purpose: Phase 18 establishes infrastructure for CJK IME. Overlay becomes first responder to receive
IME messages, but doesn't block clicks to underlying MTKView. Protocol methods are skeleton stubs
(full implementation is Phase 19).

Output:
- ime_overlay_darwin.m — VGlyphIMEOverlayView class + C API
- ime_overlay_darwin.h — Header for V bindings
- ime_overlay_stub.c — No-op stubs for non-Darwin
- c_bindings.v — Updated with overlay API bindings
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-overlay-infrastructure/18-CONTEXT.md
@.planning/phases/18-overlay-infrastructure/18-RESEARCH.md

# Existing IME bridge (being replaced by overlay approach)
@ime_bridge_macos.m
@ime_bridge_macos.h
@c_bindings.v

# Existing composition state (overlay will call these methods in Phase 19)
@composition.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: VGlyphIMEOverlayView class with NSTextInputClient skeleton</name>
  <files>ime_overlay_darwin.m, ime_overlay_darwin.h</files>
  <action>
Create ime_overlay_darwin.h with:
- VGlyphOverlayHandle typedef (void*)
- vglyph_create_ime_overlay(void* mtkView) — returns handle
- vglyph_set_focused_field(VGlyphOverlayHandle handle, const char* field_id) — focus management
- vglyph_overlay_free(VGlyphOverlayHandle handle) — cleanup

Create ime_overlay_darwin.m with:
1. VGlyphIMEOverlayView : NSView implementing NSTextInputClient protocol
2. Store weak reference to MTKView passed in factory
3. Override hitTest: to return nil (pass clicks through)
4. Override acceptsFirstResponder to return YES
5. NSTextInputClient required methods as stubs returning safe defaults:
   - insertText:replacementRange: — empty (Phase 19)
   - setMarkedText:selectedRange:replacementRange: — empty (Phase 19)
   - unmarkText — empty (Phase 19)
   - selectedRange — return NSMakeRange(NSNotFound, 0)
   - markedRange — return NSMakeRange(NSNotFound, 0)
   - hasMarkedText — return NO
   - attributedSubstringForProposedRange:actualRange: — return nil
   - validAttributesForMarkedText — return @[]
   - firstRectForCharacterRange:actualRange: — return NSZeroRect (Phase 19)
   - characterIndexForPoint: — return NSNotFound

Guard file with #ifdef __APPLE__ (or rely on build system).
Use ARC (-fobjc-arc already in c_bindings.v).
  </action>
  <verify>
File exists and compiles:
`clang -c -fobjc-arc -framework Cocoa ime_overlay_darwin.m -o /tmp/overlay_test.o`
  </verify>
  <done>
VGlyphIMEOverlayView class exists with all NSTextInputClient protocol methods.
hitTest: returns nil. acceptsFirstResponder returns YES.
  </done>
</task>

<task type="auto">
  <name>Task 2: Factory function and first responder management</name>
  <files>ime_overlay_darwin.m</files>
  <action>
Implement vglyph_create_ime_overlay:
1. Cast mtkView from void* to NSView* via __bridge
2. Get parent = mtkView.superview
3. Create VGlyphIMEOverlayView instance
4. Store weak reference to mtkView in overlay (for returning focus)
5. Add overlay as sibling above MTKView:
   [parent addSubview:overlay positioned:NSWindowAbove relativeTo:mtkView]
6. Set up Auto Layout constraints to match MTKView bounds:
   overlay.translatesAutoresizingMaskIntoConstraints = NO
   Constrain leading/trailing/top/bottom anchors to mtkView
7. Return (__bridge_retained void*)overlay

Implement vglyph_set_focused_field:
1. Cast handle to VGlyphIMEOverlayView* via __bridge
2. If field_id != NULL:
   - Store field_id in overlay property (for Phase 19 context)
   - [[overlay window] makeFirstResponder:overlay]
3. If field_id == NULL:
   - Return first responder to stored mtkView reference:
     [[overlay window] makeFirstResponder:overlay.mtkView]

Implement vglyph_overlay_free:
1. Cast handle via __bridge_transfer (ARC takes ownership and releases)
2. [overlay removeFromSuperview]
  </action>
  <verify>
Compile succeeds (same clang command as Task 1).
Function signatures match header declarations.
  </verify>
  <done>
Factory creates overlay as sibling with Auto Layout constraints.
Focus API switches first responder between overlay and MTKView.
  </done>
</task>

<task type="auto">
  <name>Task 3: Non-Darwin stub and V bindings</name>
  <files>ime_overlay_stub.c, c_bindings.v</files>
  <action>
Create ime_overlay_stub.c:
1. Guard with #ifndef __APPLE__
2. Include stddef.h for NULL
3. Implement no-op versions:
   - vglyph_create_ime_overlay returns NULL
   - vglyph_set_focused_field does nothing
   - vglyph_overlay_free does nothing

Update c_bindings.v:
1. Add #flag directives for overlay files:
   #flag darwin @VMODROOT/ime_overlay_darwin.m
   #flag !darwin @VMODROOT/ime_overlay_stub.c
2. Add #include for header:
   #include "@VMODROOT/ime_overlay_darwin.h"
3. Add C function declarations:
   fn C.vglyph_create_ime_overlay(mtk_view voidptr) voidptr
   fn C.vglyph_set_focused_field(handle voidptr, field_id &char)
   fn C.vglyph_overlay_free(handle voidptr)
4. Add V wrapper functions in module vglyph:
   pub fn ime_overlay_create(mtk_view voidptr) voidptr
   pub fn ime_overlay_set_focused_field(handle voidptr, field_id string)
   pub fn ime_overlay_free(handle voidptr)

The V wrappers should convert string to &char for field_id.
  </action>
  <verify>
Build V module: `v -check-syntax c_bindings.v`
Build on macOS: `v build .` (from vglyph directory)
Verify no undefined symbols.
  </verify>
  <done>
Non-Darwin builds compile with no-op stubs.
V API exposes overlay creation, focus management, and cleanup.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Darwin compilation:**
   ```bash
   cd /Users/mike/Documents/github/vglyph
   v -check-syntax c_bindings.v
   v build .
   ```

2. **Header/implementation match:**
   - All functions declared in ime_overlay_darwin.h are implemented in ime_overlay_darwin.m
   - Same signatures in ime_overlay_stub.c

3. **NSTextInputClient compliance:**
   - grep -c "insertText:" ime_overlay_darwin.m  # Should be >= 1
   - grep -c "setMarkedText:" ime_overlay_darwin.m  # Should be >= 1
   - grep -c "NSTextInputClient" ime_overlay_darwin.m  # Protocol declaration

4. **Click pass-through:**
   - grep "hitTest:" ime_overlay_darwin.m shows "return nil"

5. **First responder:**
   - grep "makeFirstResponder" ime_overlay_darwin.m shows both focus and blur paths
</verification>

<success_criteria>
- VGlyphIMEOverlayView class implements NSTextInputClient protocol (skeleton)
- Overlay is positioned as sibling above MTKView via addSubview:positioned:relativeTo:
- Auto Layout constraints bind overlay bounds to MTKView bounds
- hitTest: returns nil (clicks pass through)
- vglyph_set_focused_field(non-NULL) makes overlay first responder
- vglyph_set_focused_field(NULL) returns first responder to MTKView
- Non-Darwin builds compile with stub implementation
- V module builds successfully with new bindings
</success_criteria>

<output>
After completion, create `.planning/phases/18-overlay-infrastructure/18-01-SUMMARY.md`
</output>
