---
phase: 08-instrumentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [context.v, layout.v, glyph_atlas.v, renderer.v]
autonomous: true

must_haves:
  truths:
    - "Profile build with `-d profile` compiles without errors"
    - "Release build without `-d profile` has zero profiling code"
    - "Frame time breakdown captures layout/rasterize/upload/draw phases"
  artifacts:
    - path: "context.v"
      provides: "ProfileMetrics struct with timing fields"
      contains: "ProfileMetrics"
    - path: "layout.v"
      provides: "Layout timing instrumentation"
      pattern: "\\$if profile \\?"
    - path: "glyph_atlas.v"
      provides: "Rasterize/atlas timing instrumentation"
      pattern: "\\$if profile \\?"
    - path: "renderer.v"
      provides: "Draw/upload timing instrumentation"
      pattern: "\\$if profile \\?"
  key_links:
    - from: "layout.v"
      to: "context.v"
      via: "ProfileMetrics struct access"
      pattern: "profile_metrics"
    - from: "renderer.v"
      to: "glyph_atlas.v"
      via: "Atlas timing accumulation"
      pattern: "profile_metrics"
---

<objective>
Add ProfileMetrics struct and timing instrumentation to hot paths using conditional compilation.

Purpose: Enable developers to identify performance bottlenecks in layout/rasterize/upload/draw phases
with zero overhead in release builds.

Output: ProfileMetrics struct in context.v, timing instrumentation in 4 hot path files.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-instrumentation/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ProfileMetrics struct to context.v</name>
  <files>context.v</files>
  <action>
Add ProfileMetrics struct with timing fields behind `$if profile ?`:

```v
$if profile ? {
    pub struct ProfileMetrics {
    pub mut:
        // Frame timing (nanoseconds)
        layout_time_ns     i64
        rasterize_time_ns  i64
        upload_time_ns     i64
        draw_time_ns       i64

        // Cache statistics (added in Plan 02)
        // Atlas statistics (added in Plan 02)
        // Memory tracking (added in Plan 02)
    }
}
```

Add profile_metrics field to Context struct behind conditional:
```v
pub struct Context {
    // ... existing fields ...
    $if profile ? {
        pub mut:
            profile_metrics ProfileMetrics
    }
}
```

Use `time.sys_mono_now()` for nanosecond timing (import time module).
  </action>
  <verify>Run `v -d profile -check-syntax context.v` - no errors</verify>
  <done>ProfileMetrics struct exists with 4 timing fields, Context has profile_metrics field</done>
</task>

<task type="auto">
  <name>Task 2: Instrument hot paths with defer-based timing</name>
  <files>layout.v, glyph_atlas.v, renderer.v</files>
  <action>
Add timing instrumentation to 4 hot paths using defer pattern:

**layout.v - layout_text():**
```v
pub fn (mut ctx Context) layout_text(text string, cfg TextConfig) !Layout {
    $if profile ? {
        start := time.sys_mono_now()
        defer { ctx.profile_metrics.layout_time_ns += time.sys_mono_now() - start }
    }
    // ... existing code ...
}
```
Also instrument `layout_rich_text()` with same pattern.

**glyph_atlas.v - load_glyph():**
```v
fn (mut renderer Renderer) load_glyph(cfg LoadGlyphConfig) !CachedGlyph {
    $if profile ? {
        start := time.sys_mono_now()
        defer { renderer.rasterize_time_ns += time.sys_mono_now() - start }
    }
    // ... existing code ...
}
```
Note: Renderer needs profile fields added (see below).

**renderer.v - commit():**
```v
pub fn (mut renderer Renderer) commit() {
    $if profile ? {
        start := time.sys_mono_now()
        defer { renderer.upload_time_ns += time.sys_mono_now() - start }
    }
    // ... existing code ...
}
```

**renderer.v - draw_layout():**
```v
pub fn (mut renderer Renderer) draw_layout(layout Layout, x f32, y f32) {
    $if profile ? {
        start := time.sys_mono_now()
        defer { renderer.draw_time_ns += time.sys_mono_now() - start }
    }
    // ... existing code ...
}
```
Also instrument `draw_layout_rotated()`.

Add profile timing fields to Renderer struct:
```v
pub struct Renderer {
    // ... existing fields ...
    $if profile ? {
        pub mut:
            rasterize_time_ns i64
            upload_time_ns    i64
            draw_time_ns      i64
    }
}
```

Import `time` module in each file that uses timing.
  </action>
  <verify>
Run `v -d profile -check-syntax layout.v glyph_atlas.v renderer.v` - no errors.
Run `v -check-syntax layout.v glyph_atlas.v renderer.v` (without profile) - no errors, confirms conditional compilation works.
  </verify>
  <done>
4 hot paths instrumented: layout_text, load_glyph, commit, draw_layout.
Timing accumulates in nanoseconds. Zero overhead in release builds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify zero release overhead</name>
  <files></files>
  <action>
Verify conditional compilation removes all profiling code in release:

1. Build release (no -d profile): `v -prod context.v layout.v glyph_atlas.v renderer.v -o /dev/null 2>&1`
2. Build profile: `v -d profile context.v layout.v glyph_atlas.v renderer.v -o /dev/null 2>&1`

Both should compile without errors.

Check that ProfileMetrics is NOT accessible without -d profile flag by attempting:
`v -e 'import vglyph; m := vglyph.ProfileMetrics{}'` should fail (type not defined).

Run v fmt -w on all modified files.
  </action>
  <verify>
Release build succeeds.
Profile build succeeds.
ProfileMetrics inaccessible in release.
  </verify>
  <done>INST-01 satisfied: zero release overhead confirmed via conditional compilation</done>
</task>

</tasks>

<verification>
- [ ] `v -d profile -check-syntax context.v layout.v glyph_atlas.v renderer.v` passes
- [ ] `v -check-syntax context.v layout.v glyph_atlas.v renderer.v` passes (release mode)
- [ ] ProfileMetrics struct has layout_time_ns, rasterize_time_ns, upload_time_ns, draw_time_ns
- [ ] Context.profile_metrics field exists behind $if profile ?
- [ ] Renderer has profile timing fields behind $if profile ?
- [ ] All 4 hot paths have defer-based timing
</verification>

<success_criteria>
- INST-01 partially satisfied: Profiling builds compile, release has zero overhead
- INST-02 partially satisfied: Frame time breakdown captures 4 phases
- ProfileMetrics struct ready for Plan 02 to add cache/atlas fields
</success_criteria>

<output>
After completion, create `.planning/phases/08-instrumentation/08-01-SUMMARY.md`
</output>
