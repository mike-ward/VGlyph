---
phase: 13-text-mutation
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - layout_mutation.v
  - examples/editor_demo.v
autonomous: false

must_haves:
  truths:
    - "User types character and it appears at cursor"
    - "Backspace deletes previous character or selection"
    - "Delete key removes next character or selection"
    - "Cmd+C copies selection to clipboard"
    - "Cmd+X cuts selection to clipboard"
    - "Cmd+V pastes clipboard at cursor"
  artifacts:
    - path: "layout_mutation.v"
      provides: "Clipboard helper functions"
      exports: ["get_selected_text", "TextChange", "ChangeCallback"]
      contains: "pub fn get_selected_text"
    - path: "examples/editor_demo.v"
      provides: "Working text editing demo"
      contains: "handle_char_input"
  key_links:
    - from: "examples/editor_demo.v"
      to: "layout_mutation.v"
      via: "mutation function calls"
      pattern: "vglyph\\.(delete_backward|insert_text|insert_replacing_selection)"
    - from: "examples/editor_demo.v"
      to: "app.ts.layout_text"
      via: "layout regeneration after mutation"
      pattern: "layout_text.*app\\.text"
---

<objective>
Clipboard operations, change events, and editor demo integration for text mutation.

Purpose: Complete the mutation system with copy/cut support, change callbacks for undo
integration, and a working demo that handles keyboard input, deletion, and clipboard.

Output: Extended layout_mutation.v with clipboard helpers, fully functional editor demo.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-text-mutation/13-CONTEXT.md
@.planning/phases/13-text-mutation/13-RESEARCH.md
@.planning/phases/13-text-mutation/13-01-SUMMARY.md
@layout_mutation.v
@examples/editor_demo.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clipboard helpers and change event types</name>
  <files>layout_mutation.v</files>
  <action>
Add to layout_mutation.v:

1. get_selected_text function:
- Takes: text string, cursor int, anchor int
- Returns: string
- If cursor == anchor: return empty string
- sel_start = min(cursor, anchor), sel_end = max(cursor, anchor)
- Return text[sel_start..sel_end]
- Per user decision: "VGlyph copy API returns plain text only"

2. cut_selection function:
- Takes: text string, cursor int, anchor int
- Returns: (string, MutationResult) - tuple of cut text and mutation result
- If cursor == anchor: return ('', MutationResult{new_text: text, cursor_pos: cursor})
- Get selected text, then call delete_selection
- Per user decision: "Cut returns selection text + deletes it"

3. TextChange struct (for change events):
```v
pub struct TextChange {
pub:
    range_start int    // Byte offset where change begins
    range_end   int    // Byte offset where change ends (in original text)
    new_text    string // Text that was inserted
    old_text    string // Text that was removed
}
```

4. Helper to convert MutationResult to TextChange:
```v
pub fn (m MutationResult) to_change(inserted string) TextChange {
    return TextChange{
        range_start: m.range_start
        range_end:   m.range_end
        new_text:    inserted
        old_text:    m.deleted_text
    }
}
```

Per user decision: "Callback receives: range (start/end offset) + new text"
  </action>
  <verify>v fmt -w layout_mutation.v && v -check-syntax layout_mutation.v</verify>
  <done>Clipboard helpers and TextChange struct exist</done>
</task>

<task type="auto">
  <name>Task 2: Integrate mutation into editor demo</name>
  <files>examples/editor_demo.v</files>
  <action>
Modify examples/editor_demo.v:

1. Add char event handler in event() function:
```v
.char {
    // Ignore control characters
    if e.codepoint < 32 {
        return
    }

    // Convert codepoint to string
    char_str := utf32_to_string(e.codepoint)

    // Insert with selection replacement
    if app.has_selection {
        result := vglyph.insert_replacing_selection(app.text, app.cursor_idx,
            app.anchor_idx, char_str)
        app.text = result.new_text
        app.cursor_idx = result.cursor_pos
    } else {
        result := vglyph.insert_text(app.text, app.cursor_idx, char_str)
        app.text = result.new_text
        app.cursor_idx = result.cursor_pos
    }

    // Clear selection
    app.anchor_idx = app.cursor_idx
    app.has_selection = false

    // Regenerate layout
    app.layout = app.ts.layout_text(app.text, app.cfg) or { return }
}
```

2. Add Backspace handling in .key_down:
```v
.backspace {
    cmd_held := (e.modifiers & u32(gg.Modifier.super)) != 0
    opt_held := (e.modifiers & u32(gg.Modifier.alt)) != 0

    mut result := vglyph.MutationResult{}

    if app.has_selection {
        // Selection active: delete selection only (per user decision)
        result = vglyph.delete_selection(app.text, app.cursor_idx, app.anchor_idx)
    } else if cmd_held {
        // Cmd+Backspace: delete to line start
        result = vglyph.delete_to_line_start(app.text, app.layout, app.cursor_idx)
    } else if opt_held {
        // Option+Backspace: delete to word boundary
        result = vglyph.delete_to_word_boundary(app.text, app.layout, app.cursor_idx)
    } else {
        // Plain Backspace: delete one grapheme cluster
        result = vglyph.delete_backward(app.text, app.layout, app.cursor_idx)
    }

    app.text = result.new_text
    app.cursor_idx = result.cursor_pos
    app.anchor_idx = result.cursor_pos
    app.has_selection = false

    // Regenerate layout
    app.layout = app.ts.layout_text(app.text, app.cfg) or { return }
}
```

3. Add Delete key handling:
```v
.delete {
    cmd_held := (e.modifiers & u32(gg.Modifier.super)) != 0
    opt_held := (e.modifiers & u32(gg.Modifier.alt)) != 0

    mut result := vglyph.MutationResult{}

    if app.has_selection {
        result = vglyph.delete_selection(app.text, app.cursor_idx, app.anchor_idx)
    } else if cmd_held {
        result = vglyph.delete_to_line_end(app.text, app.layout, app.cursor_idx)
    } else if opt_held {
        result = vglyph.delete_to_word_end(app.text, app.layout, app.cursor_idx)
    } else {
        result = vglyph.delete_forward(app.text, app.layout, app.cursor_idx)
    }

    app.text = result.new_text
    app.cursor_idx = result.cursor_pos
    app.anchor_idx = result.cursor_pos
    app.has_selection = false

    app.layout = app.ts.layout_text(app.text, app.cfg) or { return }
}
```

4. Add helper function for codepoint to string:
```v
fn utf32_to_string(codepoint u32) string {
    if codepoint < 0x80 {
        return [u8(codepoint)].bytestr()
    } else if codepoint < 0x800 {
        return [u8(0xC0 | (codepoint >> 6)), u8(0x80 | (codepoint & 0x3F))].bytestr()
    } else if codepoint < 0x10000 {
        return [u8(0xE0 | (codepoint >> 12)), u8(0x80 | ((codepoint >> 6) & 0x3F)),
            u8(0x80 | (codepoint & 0x3F))].bytestr()
    } else {
        return [u8(0xF0 | (codepoint >> 18)), u8(0x80 | ((codepoint >> 12) & 0x3F)),
            u8(0x80 | ((codepoint >> 6) & 0x3F)), u8(0x80 | (codepoint & 0x3F))].bytestr()
    }
}
```
  </action>
  <verify>v fmt -w examples/editor_demo.v && v -check-syntax examples/editor_demo.v</verify>
  <done>Editor handles character input, backspace, and delete key</done>
</task>

<task type="auto">
  <name>Task 3: Add clipboard operations to demo</name>
  <files>examples/editor_demo.v</files>
  <action>
Add clipboard operations to editor_demo.v:

1. Add clipboard field to EditorApp struct:
```v
clipboard string  // Internal clipboard (v-gui will use system pasteboard)
```

2. In .key_down, add Cmd+C (copy):
```v
.c {
    if cmd_held && app.has_selection {
        app.clipboard = vglyph.get_selected_text(app.text, app.cursor_idx, app.anchor_idx)
        return
    }
}
```

3. Add Cmd+X (cut):
```v
.x {
    if cmd_held && app.has_selection {
        cut_text, result := vglyph.cut_selection(app.text, app.cursor_idx, app.anchor_idx)
        app.clipboard = cut_text
        app.text = result.new_text
        app.cursor_idx = result.cursor_pos
        app.anchor_idx = result.cursor_pos
        app.has_selection = false
        app.layout = app.ts.layout_text(app.text, app.cfg) or { return }
        return
    }
}
```

4. Add Cmd+V (paste):
```v
.v {
    if cmd_held && app.clipboard.len > 0 {
        // Per user decision: Paste uses generic insert_text (no separate paste method)
        mut result := vglyph.MutationResult{}
        if app.has_selection {
            result = vglyph.insert_replacing_selection(app.text, app.cursor_idx,
                app.anchor_idx, app.clipboard)
        } else {
            result = vglyph.insert_text(app.text, app.cursor_idx, app.clipboard)
        }
        app.text = result.new_text
        app.cursor_idx = result.cursor_pos
        app.anchor_idx = result.cursor_pos
        app.has_selection = false
        app.layout = app.ts.layout_text(app.text, app.cfg) or { return }
        return
    }
}
```

Note: This uses internal clipboard for demo. Per user decision, v-gui handles system pasteboard.
VGlyph provides text via get_selected_text/cut_selection, v-gui copies to/from pasteboard.
  </action>
  <verify>v fmt -w examples/editor_demo.v && v examples/editor_demo.v build</verify>
  <done>Copy, cut, paste operations work in demo</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete text mutation system: insert, delete (char/word/line), cut/copy/paste</what-built>
  <how-to-verify>
1. Run: v run examples/editor_demo.v
2. Test character insertion:
   - Type some text, verify it appears at cursor
   - Select text with mouse/keyboard, type to replace
3. Test deletion:
   - Backspace: deletes one character (or selection)
   - Delete key: deletes forward one character (or selection)
   - Option+Backspace: deletes to word boundary
   - Cmd+Backspace: deletes to line start
   - Option+Delete: deletes to word end
   - Cmd+Delete: deletes to line end
4. Test grapheme clusters:
   - Type or paste an emoji (e.g., rainbow flag)
   - Backspace should delete entire emoji in one press
5. Test clipboard:
   - Select text, Cmd+C, move cursor, Cmd+V (text pastes)
   - Select text, Cmd+X (text removed + copied), Cmd+V (paste works)
6. Verify no crashes on edge cases:
   - Backspace at start of text
   - Delete at end of text
   - Cut/copy with no selection (should do nothing)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. v fmt -w layout_mutation.v examples/editor_demo.v - Files formatted
2. v -check-syntax layout_mutation.v examples/editor_demo.v - No errors
3. v run examples/editor_demo.v - Demo launches and runs
4. Manual testing covers all requirements MUT-01 through MUT-06
</verification>

<success_criteria>
- [ ] get_selected_text returns plain text from selection
- [ ] cut_selection returns text and performs delete
- [ ] TextChange struct captures mutation info for undo
- [ ] Editor demo handles .char events for typing
- [ ] Backspace handles selection, word, line, and character deletion
- [ ] Delete key mirrors Backspace in forward direction
- [ ] Cmd+C copies selection to clipboard
- [ ] Cmd+X cuts selection to clipboard
- [ ] Cmd+V pastes clipboard at cursor (replacing selection)
- [ ] Layout regenerated after every mutation
- [ ] Emoji/grapheme clusters delete as single units
</success_criteria>

<output>
After completion, create `.planning/phases/13-text-mutation/13-02-SUMMARY.md`
</output>
