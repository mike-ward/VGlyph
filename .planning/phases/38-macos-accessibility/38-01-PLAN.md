---
phase: 38-macos-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - accessibility/backend_darwin.v
  - accessibility/objc_bindings_darwin.v
autonomous: true
must_haves:
  truths:
    - "get_window returns a valid NSWindow object"
    - "update_tree creates NSAccessibilityElement objects"
    - "Elements have correct AccessibilityRole set"
    - "Elements have Frame set in screen coordinates"
    - "Parent-child hierarchy is established (setAccessibilityParent/Children)"
    - "Root element is attached to the Window"
  artifacts:
    - path: accessibility/backend_darwin.v
      contains: "C.sapp_macos_get_window"
    - path: accessibility/backend_darwin.v
      contains: "setAccessibilityFrame"
    - path: accessibility/backend_darwin.v
      contains: "setAccessibilityParent"
  key_links:
    - from: "accessibility/backend_darwin.v"
      to: "sokol.sapp"
      via: "sapp_macos_get_window"
---

<objective>
Implement the core accessibility tree structure for macOS.
This plan focuses on getting the static accessibility tree built and attached to the window, allowing Accessibility Inspector to see the elements with correct frames and labels.

Purpose: Enable screen readers (VoiceOver) to discover UI elements.
Output: Working `get_window` and `update_tree` methods in `DarwinAccessibilityBackend`.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@accessibility/backend_darwin.v
@accessibility/objc_bindings_darwin.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Window Retrieval</name>
  <files>accessibility/backend_darwin.v</files>
  <action>
    In `accessibility/backend_darwin.v`:
    1. Declare `fn C.sapp_macos_get_window() voidptr` at the top (or inside `@[if darwin]`).
    2. Implement `get_window()` to call this function.
    3. Remove the `unsafe { nil }` stub and commented-out code.
    4. Ensure basic error handling (if window is null, return nil).
  </action>
  <verify>
    Create a small test snippet (e.g., `_check_window.v`) that imports `accessibility` and calls `get_window` (requires exposing it or using reflection/debug).
    Alternatively, since `get_window` is private, verify by compiling `accessibility` module.
    Better: rely on `update_tree` using it in Task 2.
  </verify>
  <done>
    `get_window` compiles and calls the C function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Element Creation and Properties</name>
  <files>accessibility/backend_darwin.v</files>
  <action>
    In `accessibility/backend_darwin.v` (`update_tree`):
    1. Uncomment step 1 (Create/Update Elements).
    2. Fix `label_ns` setting:
       - Use `ns_string(node.text)`.
       - Call `setAccessibilityLabel:`.
    3. Fix `frame` setting:
       - Ensure `get_window_frame` is working (helper exists).
       - Verify math: `h := win_frame.size.height - f64(node.rect.y) - f64(node.rect.height)` (Top-Left to Bottom-Left conversion).
       - Create `ns_rect` using `make_ns_rect`.
       - Call `setAccessibilityFrame:` with `v_msgSend_setFrame`.
    4. Ensure `create_element` sets the Role correctly (already implemented, just verify).
  </action>
  <verify>
    Compile `accessibility` module.
  </verify>
  <done>
    `update_tree` iterates nodes and sets Label and Frame on elements.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Hierarchy and Root Attachment</name>
  <files>accessibility/backend_darwin.v</files>
  <action>
    In `accessibility/backend_darwin.v` (`update_tree`):
    1. Uncomment step 2 (Build Hierarchy).
    2. Ensure `setAccessibilityParent:` is called for children (pointing to parent element) and root (pointing to window).
    3. Ensure `setAccessibilityChildren:` is called for parents (with `NSMutableArray` of children).
    4. Uncomment step 3 (Attach Root to Window).
    5. Ensure `setAccessibilityChildren:` is called on the **Window** itself, passing an array containing the root element.
  </action>
  <verify>
    Compile `accessibility` module.
    (Runtime verification happens in next plan or via manual check).
  </verify>
  <done>
    `update_tree` builds the full parent-child tree and attaches it to the NSWindow.
  </done>
</task>

</tasks>

<verification>
No compile errors in `accessibility` module on macOS.
</verification>

<success_criteria>
- `get_window` returns the NSWindow.
- `update_tree` executes without crashing.
- Code compiles cleanly with `-os macos`.
</success_criteria>

<output>
After completion, create `.planning/phases/38-macos-accessibility/38-01-SUMMARY.md`
</output>
