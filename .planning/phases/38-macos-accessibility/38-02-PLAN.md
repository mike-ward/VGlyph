---
phase: 38-macos-accessibility
plan: 02
type: execute
wave: 2
depends_on: [38-01]
files_modified:
  - accessibility/backend_darwin.v
  - accessibility/objc_bindings_darwin.v
autonomous: true
must_haves:
  truths:
    - "Text Fields update their value (setAccessibilityValue)"
    - "Text Fields update selection (setAccessibilitySelectedTextRange)"
    - "Focus changes are reflected (setAccessibilityFocusedUIElement)"
    - "Notifications are posted (NSAccessibilityPostNotification)"
  artifacts:
    - path: accessibility/objc_bindings_darwin.v
      contains: "ns_value_with_range"
    - path: accessibility/backend_darwin.v
      contains: "setAccessibilityValue"
    - path: accessibility/backend_darwin.v
      contains: "setAccessibilitySelectedTextRange"
  key_links:
    - from: "accessibility/backend_darwin.v"
      to: "NSAccessibilityPostNotification"
      via: "post_notification"
---

<objective>
Implement dynamic accessibility features: text values, selection, focus management, and notifications.
This enables the accessibility tree to reflect the live state of the application.

Purpose: Allow screen readers to read text content, follow cursor movement, and announce events.
Output: Working `update_text_field`, `set_focus`, and `post_notification` methods.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/38-macos-accessibility/38-01-SUMMARY.md
@accessibility/backend_darwin.v
@accessibility/objc_bindings_darwin.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NSValue Helper</name>
  <files>accessibility/objc_bindings_darwin.v</files>
  <action>
    In `accessibility/objc_bindings_darwin.v`:
    1. Define `fn C.v_NSValue_valueWithRange(range C.NSRange) Id` (or wrapped version).
       - Note: `NSValue` is a class, `valueWithRange:` is a class method.
       - Use `objc_getClass("NSValue")` and `sel_register_name("valueWithRange:")` if C wrapper not available, OR define a helper `ns_value_with_range(range C.NSRange) Id`.
    2. Implement `ns_value_with_range` using `v_msgSend`.
       - Need `v_msgSend_id_nsrange` or equivalent (struct return/arg handling in V can be tricky with `msgSend`).
       - *Strategy*: V's `C.objc_msgSend` might handle struct args if defined correctly.
       - Better: Use a small C wrapper in a `.m` file?
       - *Alternative*: `accessibility/objc_helpers.h` might already have helpers or we can add one if feasible.
       - *Best for now*: Use `v_msgSend` with proper casting or define specific C function for it if possible.
       - *Implementation*:
         ```v
         fn C.v_msgSend_range(self Id, op SEL, range C.NSRange) Id
         ```
         And use it.
  </action>
  <verify>
    Compile check.
  </verify>
  <done>
    `ns_value_with_range` helper is available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Text Field Updates</name>
  <files>accessibility/backend_darwin.v</files>
  <action>
    In `accessibility/backend_darwin.v`:
    1. Implement `update_text_field`:
       - Retrieve element by `node_id`.
       - `value_ns := ns_string(value)`.
       - `C.v_msgSend_void_id(elem, sel_register_name('setAccessibilityValue:'), value_ns)`.
       - Create `ns_range := make_ns_range(selected_range.location, selected_range.length)`.
       - Wrap in `NSValue`: `val_range := ns_value_with_range(ns_range)`.
       - `C.v_msgSend_void_id(elem, sel_register_name('setAccessibilitySelectedTextRange:'), val_range)`.
  </action>
  <verify>
    Compile check.
  </verify>
  <done>
    `update_text_field` sets value and selection on the native element.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Focus and Notifications</name>
  <files>accessibility/backend_darwin.v</files>
  <action>
    In `accessibility/backend_darwin.v`:
    1. Implement `set_focus(node_id)`:
       - Get `window` and `elem`.
       - Call `[window setAccessibilityFocusedUIElement:elem]`.
    2. Implement `post_notification(node_id, notification)`:
       - Map `AccessibilityNotification` enum to NSStrings:
         - `.value_changed` -> `NSAccessibilityValueChangedNotification`
         - `.selected_text_changed` -> `NSAccessibilitySelectedTextChangedNotification`
       - Call `C.v_NSAccessibilityPostNotification(elem, ns_string(name))`.
  </action>
  <verify>
    Compile check.
  </verify>
  <done>
    Focus and notifications are wired up.
  </done>
</task>

</tasks>

<verification>
Compile `accessibility` module.
</verification>

<success_criteria>
- Text field updates compile and use correct selectors.
- Focus setting uses window method.
- Notifications map correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/38-macos-accessibility/38-02-SUMMARY.md`
</output>
