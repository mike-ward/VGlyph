---
phase: 03-layout-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [layout.v, layout_types.v]
autonomous: true

must_haves:
  truths:
    - "Pointer cast at line 156 has documentation explaining safety assumption"
    - "Debug builds validate the pointer cast at runtime"
    - "Inline object IDs are cloned before passing to Pango"
    - "Cloned strings are freed when Layout is destroyed"
  artifacts:
    - path: "layout.v"
      provides: "Pointer documentation, debug validation, string cloning in layout_rich_text"
      contains: "PangoLayoutRun is a typedef for PangoGlyphItem"
    - path: "layout_types.v"
      provides: "Layout struct with cloned_object_ids field and destroy method"
      contains: "cloned_object_ids"
  key_links:
    - from: "layout.v:layout_rich_text"
      to: "apply_rich_text_style"
      via: "mut cloned_ids array passed by reference"
      pattern: "apply_rich_text_style.*&cloned_ids"
    - from: "layout.v:layout_rich_text"
      to: "Layout construction"
      via: "cloned_object_ids field assignment"
      pattern: "cloned_object_ids:.*cloned_ids"
    - from: "layout_types.v:Layout.destroy"
      to: "cloned_object_ids"
      via: "iterate and free each string"
      pattern: "for.*cloned_object_ids.*free"
---

<objective>
Document unsafe pointer cast and fix string lifetime for inline object IDs in layout system.

Purpose: Prevent undefined behavior from undocumented assumptions and use-after-free in C FFI
Output: Safe, documented layout code with proper string lifetime management
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-layout-safety/03-CONTEXT.md
@.planning/phases/03-layout-safety/03-RESEARCH.md
@layout.v
@layout_types.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document pointer cast and add debug validation</name>
  <files>layout.v</files>
  <action>
At line 153-156 in build_layout_from_pango where the pointer cast happens:

1. Add brief inline comment (1-2 lines) above the cast explaining:
   - PangoLayoutRun is a typedef for PangoGlyphItem (safe to cast)
   - Reference: https://docs.gtk.org/Pango/struct.LayoutRun.html

2. Add $if debug block after the cast with:
   - Null check on run pointer
   - Panic with simple message if null (not assert, per user decision)

Example structure:
```v
// PangoLayoutRun is a typedef for PangoGlyphItem - cast is safe per Pango API
// See: https://docs.gtk.org/Pango/struct.LayoutRun.html
run := unsafe { &C.PangoLayoutRun(run_ptr) }
$if debug {
    if voidptr(run) == unsafe { nil } {
        panic('PangoLayoutRun cast returned nil')
    }
}
```
  </action>
  <verify>v -check-syntax layout.v</verify>
  <done>Pointer cast has documentation comment and debug validation with panic</done>
</task>

<task type="auto">
  <name>Task 2a: Add cloned_object_ids field and destroy method to Layout</name>
  <files>layout_types.v</files>
  <action>
1. Add `cloned_object_ids []string` field to Layout struct in the `pub mut:` section (after line 6):

```v
pub struct Layout {
pub mut:
    cloned_object_ids  []string  // Cloned inline object IDs for Pango lifetime
    items              []Item
    // ... rest unchanged
```

2. Add Layout.destroy() method at end of file (per user decision - use destroy() not free()):

```v
// destroy frees resources owned by the Layout.
// Call when Layout is no longer needed to prevent memory leaks.
pub fn (mut l Layout) destroy() {
    for s in l.cloned_object_ids {
        if s.len > 0 {
            unsafe { free(s.str) }
        }
    }
    l.cloned_object_ids = []
}
```
  </action>
  <verify>v -check-syntax layout_types.v</verify>
  <done>Layout struct has cloned_object_ids field and destroy() method</done>
</task>

<task type="auto">
  <name>Task 2b: Wire string cloning through layout_rich_text</name>
  <files>layout.v</files>
  <action>
**Part 1: Update apply_rich_text_style signature (line 831)**

Change from:
```v
fn apply_rich_text_style(mut ctx Context, list &C.PangoAttrList, style TextStyle, start int, end int) {
```

To:
```v
fn apply_rich_text_style(mut ctx Context, list &C.PangoAttrList, style TextStyle, start int, end int, mut cloned_ids []string) {
```

**Part 2: Clone string in apply_rich_text_style inline object section (around line 960-969)**

Replace:
```v
// Pass object ID as data.
// Warning: This assumes obj.id string data remains valid during layout.
data_ptr := unsafe { obj.id.str }
```

With:
```v
// Clone object ID to ensure lifetime exceeds Pango usage.
// Skip cloning empty strings (per user decision).
mut data_ptr := unsafe { nil }
if obj.id.len > 0 {
    cloned_id := obj.id.clone()
    cloned_ids << cloned_id
    data_ptr = unsafe { cloned_id.str }
}
```

**Part 3: Update layout_rich_text to pass cloned_ids array (around line 91-94)**

Before the for loop that calls apply_rich_text_style, add:
```v
mut cloned_ids := []string{}
```

Update the call at line 93 from:
```v
apply_rich_text_style(mut ctx, attr_list, run.style, run.start, run.end)
```

To:
```v
apply_rich_text_style(mut ctx, attr_list, run.style, run.start, run.end, mut cloned_ids)
```

**Part 4: Update build_layout_from_pango call in layout_rich_text (line 100)**

The return at line 100 currently calls build_layout_from_pango which returns Layout.
We need to capture it, set cloned_object_ids, then return:

Replace:
```v
return build_layout_from_pango(layout, text, ctx.scale_factor, cfg)
```

With:
```v
mut result := build_layout_from_pango(layout, text, ctx.scale_factor, cfg)
result.cloned_object_ids = cloned_ids
return result
```

**Part 5: layout_text does not use inline objects**

No changes needed to layout_text (line 25-37) - it does not call apply_rich_text_style
and does not support inline objects. Confirmed by code inspection.
  </action>
  <verify>v -check-syntax layout.v && v -check-syntax layout_types.v</verify>
  <done>Object IDs cloned in apply_rich_text_style, tracked in layout_rich_text, assigned to Layout</done>
</task>

</tasks>

<verification>
- v -check-syntax layout.v
- v -check-syntax layout_types.v
- Comment exists above pointer cast at line ~156
- $if debug block exists after cast
- Layout struct has cloned_object_ids field
- Layout.destroy() method exists and frees strings
- apply_rich_text_style has cloned_ids parameter
- layout_rich_text creates cloned_ids array and passes to apply_rich_text_style
- layout_rich_text assigns cloned_ids to result.cloned_object_ids
</verification>

<success_criteria>
1. Pointer cast documented with Pango reference URL
2. Debug builds panic if cast returns nil
3. Inline object IDs cloned before passing to Pango
4. Layout.destroy() properly frees all cloned strings
5. Code compiles with v -check-syntax
</success_criteria>

<output>
After completion, create `.planning/phases/03-layout-safety/03-01-SUMMARY.md`
</output>
