---
phase: 26-shelf-packing
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - examples/atlas_debug.v
  - glyph_atlas.v
autonomous: false

must_haves:
  truths:
    - "Shelf boundaries visible in atlas_debug visualization"
    - "Each shelf shows used portion vs total width"
    - "Utilization metric displayed on screen"
  artifacts:
    - path: "examples/atlas_debug.v"
      provides: "Shelf debug visualization"
      contains: "draw.*shelf"
    - path: "glyph_atlas.v"
      provides: "Public shelf access for debug"
      contains: "pub fn.*shelves"
  key_links:
    - from: "atlas_debug.v"
      to: "glyph_atlas.v"
      via: "get_shelves or direct shelf access"
      pattern: "shelves|get_shelf"
---

<objective>
Add shelf boundary visualization to atlas_debug example

Purpose: Enable visual debugging of shelf allocation. Success Criteria #4 requires "Shelf
boundaries visible in atlas_debug example output." This helps validate BHF algorithm works
correctly and diagnose utilization issues.

Output: Updated atlas_debug.v with shelf boundary lines and utilization display
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/26-shelf-packing/26-01-SUMMARY.md

# Files to modify
@examples/atlas_debug.v
@glyph_atlas.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expose shelf data for debug visualization</name>
  <files>glyph_atlas.v</files>
  <action>
1. Add public method to TextSystem (via Renderer) to access shelf debug info:

In api.v or glyph_atlas.v, add struct and method:
```v
// ShelfDebugInfo provides shelf data for visualization
pub struct ShelfDebugInfo {
pub:
    y        int  // Shelf top Y position
    height   int  // Shelf height
    used_x   int  // Used horizontal space (cursor_x)
    width    int  // Total shelf width
}

pub struct AtlasDebugInfo {
pub:
    page_width   int
    page_height  int
    shelves      []ShelfDebugInfo
    used_pixels  i64
    total_pixels i64
}
```

2. Add method to get debug info (in renderer.v or where TextSystem is):
```v
// get_atlas_debug_info returns shelf layout info for visualization
pub fn (ts &TextSystem) get_atlas_debug_info() AtlasDebugInfo {
    // Get current page from renderer's atlas
    if ts.renderer.atlas.pages.len == 0 {
        return AtlasDebugInfo{}
    }
    page := ts.renderer.atlas.pages[ts.renderer.atlas.current_page]

    mut shelves := []ShelfDebugInfo{cap: page.shelves.len}
    for shelf in page.shelves {
        shelves << ShelfDebugInfo{
            y:      shelf.y
            height: shelf.height
            used_x: shelf.cursor_x
            width:  shelf.width
        }
    }

    return AtlasDebugInfo{
        page_width:   page.width
        page_height:  page.height
        shelves:      shelves
        used_pixels:  page.used_pixels
        total_pixels: i64(page.width) * i64(page.height)
    }
}
```

3. Ensure Shelf struct fields are accessible (already in glyph_atlas.v from Plan 01)
  </action>
  <verify>
`v -check-syntax glyph_atlas.v` and `v -check-syntax renderer.v` succeed
  </verify>
  <done>
ShelfDebugInfo and AtlasDebugInfo structs exist. get_atlas_debug_info() method available
on TextSystem for debug visualization.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add shelf visualization to atlas_debug</name>
  <files>examples/atlas_debug.v</files>
  <action>
1. In frame() function, after drawing the atlas texture, add shelf overlay:

```v
// Get shelf debug info
debug_info := app.text_system.get_atlas_debug_info()

// Calculate scale factor (atlas displayed at 50%)
scale := atlas_w / f32(debug_info.page_width)

// Draw shelf boundaries
for shelf in debug_info.shelves {
    // Shelf top boundary (red line)
    shelf_y := atlas_y + f32(shelf.y) * scale
    shelf_h := f32(shelf.height) * scale
    used_w := f32(shelf.used_x) * scale

    // Draw shelf outline (gray, full width)
    app.ctx.draw_rect_empty(atlas_x, shelf_y, atlas_w, shelf_h, gg.rgb(80, 80, 80))

    // Draw used portion (green fill, low alpha)
    app.ctx.draw_rect_filled(atlas_x, shelf_y, used_w, shelf_h, gg.Color{r: 0, g: 255, b: 0, a: 40})

    // Draw used boundary (bright green line)
    app.ctx.draw_line(atlas_x + used_w, shelf_y, atlas_x + used_w, shelf_y + shelf_h,
        gg.rgb(0, 255, 0))
}

// Display utilization percentage
utilization := if debug_info.total_pixels > 0 {
    f32(debug_info.used_pixels) / f32(debug_info.total_pixels) * 100.0
} else {
    0.0
}
util_text := 'Utilization: ${utilization:.1f}% (${debug_info.shelves.len} shelves)'
app.ctx.draw_text(int(atlas_x), int(atlas_y + atlas_h + 10), util_text, gg.TextCfg{
    color: gg.white
    size:  14
})
```

2. Add shelf count and utilization stats below atlas visualization

3. Use colors:
   - Gray outline: full shelf boundary
   - Green fill (low alpha): used portion of shelf
   - Bright green line: cursor_x position in each shelf
  </action>
  <verify>
```bash
v fmt -w examples/atlas_debug.v
v run examples/atlas_debug.v  # Visual: shelf boundaries visible, utilization displayed
```
  </verify>
  <done>
atlas_debug shows shelf boundaries with gray outlines, green used-portion fill,
and utilization percentage below atlas image.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Shelf BHF allocation with debug visualization:
- Shelf-based atlas allocation (Plan 01)
- Shelf boundary visualization in atlas_debug
- Utilization percentage display
  </what-built>
  <how-to-verify>
1. Run: `v run examples/atlas_debug.v`
2. Verify:
   - Text renders correctly (top portion of window)
   - Atlas texture visible (bottom portion)
   - Gray shelf boundaries visible in atlas
   - Green highlighting shows used portion of each shelf
   - Utilization percentage shown below atlas (should be >= 75%)
   - Shelf count reasonable (typically 5-15 for mixed text)
3. Test different text by editing atlas_debug.v or running longer
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `v fmt -w examples/atlas_debug.v` succeeds
2. `v run examples/atlas_debug.v` shows:
   - Text renders correctly
   - Shelf boundaries visible in atlas view
   - Utilization >= 75% displayed
3. `v test .` passes
</verification>

<success_criteria>
- Shelf boundaries visible in atlas_debug (gray outlines)
- Used portion highlighted (green)
- Utilization percentage displayed
- Human verification confirms visual correctness
</success_criteria>

<output>
After completion, create `.planning/phases/26-shelf-packing/26-02-SUMMARY.md`
</output>
