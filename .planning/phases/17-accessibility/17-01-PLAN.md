---
phase: 17-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - accessibility/accessibility_types.v
  - accessibility/backend.v
  - accessibility/backend_darwin.v
  - accessibility/objc_bindings_darwin.v
  - accessibility/manager.v
autonomous: true

must_haves:
  truths:
    - "Text field role exists for editable text"
    - "Backend can post notifications on state changes"
    - "Text field attributes (value, selectedRange, lineNumber) exposed to VoiceOver"
  artifacts:
    - path: "accessibility/accessibility_types.v"
      provides: "TextFieldAccessibilityNode struct, Range struct, text_field role"
      contains: "text_field"
    - path: "accessibility/backend_darwin.v"
      provides: "post_notification, set_text_field_attributes methods"
      contains: "post_notification"
    - path: "accessibility/objc_bindings_darwin.v"
      provides: "NSAccessibility notification constants"
      contains: "NSAccessibilityValueChangedNotification"
  key_links:
    - from: "accessibility/manager.v"
      to: "accessibility/backend_darwin.v"
      via: "post_notification call"
      pattern: "backend\\.post_notification"
---

<objective>
Add text field accessibility types and backend notification support for VoiceOver integration.

Purpose: Enable VoiceOver to track cursor position and text changes in editable text fields.
Output: Extended accessibility types with text_field role, notification posting infrastructure.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-accessibility/17-CONTEXT.md
@.planning/phases/17-accessibility/17-RESEARCH.md
@accessibility/accessibility_types.v
@accessibility/backend.v
@accessibility/backend_darwin.v
@accessibility/objc_bindings_darwin.v
@accessibility/manager.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add text field types and notification infrastructure</name>
  <files>
    accessibility/accessibility_types.v
    accessibility/objc_bindings_darwin.v
  </files>
  <action>
In accessibility_types.v:
1. Add `text_field` to AccessibilityRole enum
2. Add Range struct: `pub struct Range { pub: location int; length int }` (NSRange equivalent)
3. Add AccessibilityNotification enum with:
   - value_changed (NSAccessibilityValueChangedNotification)
   - selected_text_changed (NSAccessibilitySelectedTextChangedNotification)
4. Add TextFieldAccessibilityNode struct extending AccessibilityNode with:
   - value string (text content)
   - selected_range Range (cursor/selection, length=0 for no selection)
   - cursor_line int (1-indexed line number)
   - num_characters int (text length)

In objc_bindings_darwin.v:
1. Add NSAccessibilityPostNotification binding
2. Add helper function: `pub fn post_accessibility_notification(element Id, notification string)`
3. Add make_ns_range helper: `pub fn make_ns_range(location int, length int) C.NSRange`
4. Add C.NSRange struct binding if not exists
  </action>
  <verify>v -check-syntax accessibility/accessibility_types.v && v -check-syntax accessibility/objc_bindings_darwin.v</verify>
  <done>TextFieldAccessibilityNode, Range, AccessibilityNotification types exist. Notification posting helpers available.</done>
</task>

<task type="auto">
  <name>Task 2: Extend backend interface and darwin implementation</name>
  <files>
    accessibility/backend.v
    accessibility/backend_darwin.v
    accessibility/backend_stub.v
  </files>
  <action>
In backend.v:
1. Add to AccessibilityBackend interface:
   - post_notification(node_id int, notification AccessibilityNotification)
   - update_text_field(node_id int, value string, selected_range Range, cursor_line int)

In backend_darwin.v:
1. Implement post_notification:
   - Get element from b.elements[node_id]
   - Call NSAccessibilityPostNotification(element, notification_string)
   - Map AccessibilityNotification enum to NSAccessibility constant strings
2. Implement update_text_field:
   - Set NSAccessibilityValueAttribute (text content)
   - Set NSAccessibilitySelectedTextRangeAttribute (as NSRange via NSValue)
   - Set NSAccessibilityInsertionPointLineNumberAttribute (cursor line, 1-indexed)
   - Set NSAccessibilityNumberOfCharactersAttribute (text length)
3. Update get_role_string to handle text_field role -> "AXTextField"
4. Update create_element to call setAccessibilityEnabled:YES for text fields

In backend_stub.v:
1. Add stub implementations for post_notification and update_text_field (no-op)
  </action>
  <verify>v -check-syntax accessibility/backend.v && v -check-syntax accessibility/backend_darwin.v && v -check-syntax accessibility/backend_stub.v</verify>
  <done>Backend interface has notification/text-field methods. Darwin backend posts notifications and sets text field attributes.</done>
</task>

<task type="auto">
  <name>Task 3: Add text field node management to AccessibilityManager</name>
  <files>
    accessibility/manager.v
  </files>
  <action>
Add to AccessibilityManager:

1. Add create_text_field_node method:
   ```v
   pub fn (mut am AccessibilityManager) create_text_field_node(rect gg.Rect) int {
       // Ensure root exists
       if am.nodes.len == 0 {
           am.reset()
       }
       id := am.next_node_id()
       node := AccessibilityNode{
           id: id
           role: .text_field
           rect: rect
           parent: am.root_id
       }
       am.nodes[id] = node
       // Add to root children
       mut parent_node := am.nodes[am.root_id]
       parent_node.children << id
       am.nodes[am.root_id] = parent_node
       return id
   }
   ```

2. Add update_text_field method:
   ```v
   pub fn (mut am AccessibilityManager) update_text_field(node_id int, value string,
       selected_range Range, cursor_line int) {
       am.backend.update_text_field(node_id, value, selected_range, cursor_line)
   }
   ```

3. Add post_notification method:
   ```v
   pub fn (mut am AccessibilityManager) post_notification(node_id int,
       notification AccessibilityNotification) {
       am.backend.post_notification(node_id, notification)
   }
   ```

4. Import Range and AccessibilityNotification types at top of file
  </action>
  <verify>v -check-syntax accessibility/manager.v</verify>
  <done>AccessibilityManager can create text field nodes, update their attributes, and post notifications.</done>
</task>

</tasks>

<verification>
- All V files in accessibility/ compile: `v -check-syntax accessibility/`
- No new warnings from v fmt: `v fmt -verify accessibility/`
- Existing accessibility_simple.v example still compiles: `v -check-syntax examples/accessibility_simple.v`
</verification>

<success_criteria>
- text_field role exists in AccessibilityRole enum
- TextFieldAccessibilityNode struct has value, selected_range, cursor_line, num_characters fields
- AccessibilityNotification enum has value_changed and selected_text_changed
- Backend interface has post_notification and update_text_field methods
- Darwin backend implements notification posting via NSAccessibilityPostNotification
- AccessibilityManager has create_text_field_node, update_text_field, post_notification methods
</success_criteria>

<output>
After completion, create `.planning/phases/17-accessibility/17-01-SUMMARY.md`
</output>
