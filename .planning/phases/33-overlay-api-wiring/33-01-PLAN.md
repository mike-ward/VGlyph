---
phase: 33-overlay-api-wiring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ime_overlay_darwin.m
  - ime_overlay_darwin.h
  - ime_overlay_stub.c
  - c_bindings.v
autonomous: true

must_haves:
  truths:
    - "vglyph_discover_mtkview_from_window(ns_window) returns MTKView pointer from NSWindow"
    - "vglyph_create_ime_overlay_auto(ns_window) creates overlay via auto-discovery"
    - "Discovery returns NULL with stderr message when MTKView not found"
    - "Linux stub compiles and links with new auto-discover function returning NULL"
    - "No macOS types (MTKView*, NSWindow*) leak into public header"
  artifacts:
    - path: "ime_overlay_darwin.m"
      provides: "MTKView discovery + auto-create implementation"
      contains: "findViewByClass"
    - path: "ime_overlay_darwin.h"
      provides: "Auto-discover API declaration"
      contains: "vglyph_create_ime_overlay_auto"
    - path: "ime_overlay_stub.c"
      provides: "Linux stub for auto-discover"
      contains: "vglyph_create_ime_overlay_auto"
    - path: "c_bindings.v"
      provides: "V binding for auto-discover"
      contains: "ime_overlay_create_auto"
  key_links:
    - from: "c_bindings.v"
      to: "ime_overlay_darwin.m"
      via: "C FFI function call"
      pattern: "C\\.vglyph_create_ime_overlay_auto"
    - from: "ime_overlay_darwin.m"
      to: "ime_overlay_darwin.h"
      via: "header inclusion"
      pattern: "vglyph_create_ime_overlay_auto"
    - from: "ime_overlay_stub.c"
      to: "ime_overlay_darwin.h"
      via: "header inclusion"
      pattern: "vglyph_create_ime_overlay_auto"
---

<objective>
Add MTKView discovery helper and auto-create overlay API so consumers
can create overlays from NSWindow without manually finding MTKView.

Purpose: Foundation for switching editor_demo from global to per-overlay
IME callbacks. Unblocks IME-01, IME-02, IME-06.

Output: New C API function `vglyph_create_ime_overlay_auto(void* ns_window)`
with V wrapper, discovery helper in Obj-C, updated Linux stubs.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-overlay-api-wiring/33-CONTEXT.md
@.planning/phases/33-overlay-api-wiring/33-RESEARCH.md
@ime_overlay_darwin.h
@ime_overlay_darwin.m
@ime_overlay_stub.c
@c_bindings.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MTKView discovery and auto-create API</name>
  <files>
    ime_overlay_darwin.h
    ime_overlay_darwin.m
    ime_overlay_stub.c
  </files>
  <action>
**ime_overlay_darwin.h** — Add declaration above existing `vglyph_create_ime_overlay`:

```c
// Discover MTKView from NSWindow via view hierarchy walk
// Returns MTKView pointer or NULL if not found (logs to stderr)
void* vglyph_discover_mtkview_from_window(void* ns_window);

// Create overlay via auto-discovery from NSWindow
// Walks NSWindow view hierarchy to find MTKView, then creates overlay
// Returns handle or NULL on failure (MTKView not found, or creation error)
VGlyphOverlayHandle vglyph_create_ime_overlay_auto(void* ns_window);
```

All parameters are `void*` — no macOS types in public header.

**ime_overlay_darwin.m** — Add discovery implementation ABOVE the
existing `#pragma mark - C API Implementation` section:

1. Static helper `findViewByClass(NSView* root, NSString* className, int depth)`:
   - Return root if `[root.className isEqualToString:className]`
   - Recurse into `root.subviews` (depth-first)
   - Depth limit 100 (sanity check, real hierarchy is 2-3 levels)
   - Return nil if not found

2. `vglyph_discover_mtkview_from_window(void* ns_window)`:
   - Guard: `if (!ns_window) return NULL;`
   - Cast: `NSWindow* window = (__bridge NSWindow*)ns_window;`
   - Get contentView, guard NULL
   - Call `findViewByClass(contentView, @"MTKView", 0)`
   - If NULL: `fprintf(stderr, "vglyph: MTKView not found in window view hierarchy\n")`
   - Return result (as `void*`, implicit cast from NSView*)

3. `vglyph_create_ime_overlay_auto(void* ns_window)`:
   - Call `vglyph_discover_mtkview_from_window(ns_window)`
   - If NULL: return NULL (hard error per CONTEXT.md — no silent fallback)
   - Call existing `vglyph_create_ime_overlay(mtk_view)` and return result

**ime_overlay_stub.c** — Add stubs inside the `#ifndef __APPLE__` block:

```c
// Discover MTKView (no-op on non-Darwin)
void* vglyph_discover_mtkview_from_window(void* ns_window) {
    (void)ns_window;
    return NULL;
}

// Create overlay via auto-discovery (no-op on non-Darwin)
void* vglyph_create_ime_overlay_auto(void* ns_window) {
    (void)ns_window;
    return NULL;
}
```

Stubs return NULL (never non-NULL per Pitfall #5 from RESEARCH.md).
  </action>
  <verify>
Run `v -check-syntax c_bindings.v` (should pass — header changes
only, V bindings in next task). Visually inspect that ime_overlay_darwin.h
has no macOS types (MTKView*, NSWindow*) in declarations.
  </verify>
  <done>
Discovery helper walks view hierarchy recursively. Auto-create API
calls discovery then existing create. Header uses only void* types.
Stubs return NULL. Depth limit 100 as sanity check.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add V bindings for auto-discover API</name>
  <files>c_bindings.v</files>
  <action>
In `c_bindings.v`, locate the existing IME overlay C function
declarations (around line 753) and the V wrappers (around line 788).

1. Add C function declaration near existing overlay declarations:

```v
fn C.vglyph_discover_mtkview_from_window(ns_window voidptr) voidptr
fn C.vglyph_create_ime_overlay_auto(ns_window voidptr) voidptr
```

2. Add V wrapper functions near existing `ime_overlay_create`:

```v
// ime_discover_mtkview finds MTKView in NSWindow's view hierarchy.
// Returns MTKView pointer or nil if not found.
pub fn ime_discover_mtkview(ns_window voidptr) voidptr {
	return C.vglyph_discover_mtkview_from_window(ns_window)
}

// ime_overlay_create_auto creates overlay by auto-discovering MTKView
// from NSWindow. Returns overlay handle or nil on failure.
pub fn ime_overlay_create_auto(ns_window voidptr) voidptr {
	return C.vglyph_create_ime_overlay_auto(ns_window)
}
```

Run `v fmt -w c_bindings.v` after editing.
  </action>
  <verify>
Run `v -check-syntax c_bindings.v` — must pass.
Run `v fmt -w c_bindings.v` — must produce no changes (already formatted).
  </verify>
  <done>
V bindings expose `ime_discover_mtkview()` and `ime_overlay_create_auto()`
as public functions in vglyph module. Both accept voidptr, return voidptr.
  </done>
</task>

</tasks>

<verification>
1. `v -check-syntax c_bindings.v` passes
2. `v fmt -w c_bindings.v` produces no diff
3. `ime_overlay_darwin.h` contains `vglyph_create_ime_overlay_auto`
   and `vglyph_discover_mtkview_from_window` with void* only
4. `ime_overlay_stub.c` contains both new stubs returning NULL
5. `ime_overlay_darwin.m` contains `findViewByClass` with depth limit
</verification>

<success_criteria>
Auto-discover API exists in C header, Obj-C implementation, Linux stubs,
and V bindings. No macOS types leak into public header. Discovery walks
view hierarchy recursively with depth limit. Hard error (NULL return) when
MTKView not found.
</success_criteria>

<output>
After completion, create `.planning/phases/33-overlay-api-wiring/33-01-SUMMARY.md`
</output>
