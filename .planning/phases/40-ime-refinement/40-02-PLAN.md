---
phase: 40-ime-refinement
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified: [api.v]
autonomous: true
must_haves:
  truths:
    - "StandardIMEHandler struct exists in api.v"
    - "Static wrapper functions (ime_standard_*) exist in api.v"
    - "StandardIMEHandler implements commit, marked, and bounds logic"
    - "Validation is applied within the handler"
  artifacts:
    - path: "api.v"
      provides: "StandardIMEHandler and callbacks"
      contains: "pub struct StandardIMEHandler"
  key_links:
    - from: "StandardIMEHandler"
      to: "TextSystem"
      via: "ts field"
---

<objective>
Provide `StandardIMEHandler` in `api.v`.

Purpose: Implement common callback patterns with built-in validation to reduce application complexity.
Output: `StandardIMEHandler` struct and static wrapper functions in `api.v`.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/40-ime-refinement/40-CONTEXT.md
@.planning/phases/40-ime-refinement/40-01-SUMMARY.md
@api.v
@composition.v
@validation.v
</context>

<tasks>

<task type="auto">
  <name>Define StandardIMEHandler and Callbacks</name>
  <files>api.v</files>
  <action>
    Add `StandardIMEHandler` struct to `api.v`:
    - `ts &TextSystem`: Reference to managed state.
    - `user_data voidptr`: App-specific state.
    - `on_commit fn(text string, data voidptr)`: Called when IME commits text.
    - `on_update fn(data voidptr)`: Called when preedit changes (app should re-layout/repaint).
    - `get_layout fn(data voidptr) &Layout`: Called to get current layout for bounds.
    - `get_offset fn(data voidptr) (f32, f32)`: Called to get field render offset for bounds.

    Implement static wrapper functions (prefixed with `ime_standard_`):
    - `ime_standard_marked_text(text &char, pos int, data voidptr)`
    - `ime_standard_insert_text(text &char, data voidptr)`
    - `ime_standard_unmark_text(data voidptr)`
    - `ime_standard_bounds(data voidptr, x &f32, y &f32, w &f32, h &f32) bool`
    - `ime_standard_clause(start int, len int, style int, data voidptr)`
    - `ime_standard_clauses_begin(data voidptr)`
    - `ime_standard_clauses_end(data voidptr)`

    Logic in these functions:
    - Cast `data` to `&StandardIMEHandler`.
    - Apply `validate_text_input` to incoming strings.
    - Update `handler.ts.composition` state using `handle_*` methods from `composition.v`.
    - For `insert_text`, call `handler.on_commit` with validated text.
    - For `marked_text` and `unmark_text`, call `handler.on_update`.
    - For `bounds`, use `handler.get_layout` and `handler.get_offset` to calculate screen coordinates.
  </action>
  <verify>
    Check syntax with `v fmt -w api.v`.
    Ensure `StandardIMEHandler` and all callbacks are defined.
  </verify>
  <done>
    StandardIMEHandler is implemented and ready for use.
  </done>
</task>

</tasks>

<verification>
Ensure `api.v` compiles.
</verification>

<success_criteria>
- StandardIMEHandler provides a complete implementation of IME callbacks.
- Validation is centralized in the handler.
- Decoupling is achieved through the provided callbacks.
</success_criteria>

<output>
After completion, create `.planning/phases/40-ime-refinement/40-02-SUMMARY.md`
</output>
