---
phase: 40-ime-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [api.v]
autonomous: true
must_haves:
  truths:
    - "TextSystem struct has composition and dead_key fields"
    - "TextSystem initializes these fields in new_text_system"
    - "TextSystem has methods to access/reset these states"
  artifacts:
    - path: "api.v"
      provides: "TextSystem with IME state"
      contains: "pub mut: composition CompositionState"
  key_links:
    - from: "TextSystem"
      to: "CompositionState"
      via: "field composition"
      pattern: "composition\s+CompositionState"
---

<objective>
Refactor `TextSystem` to manage IME state (`CompositionState` and `DeadKeyState`).

Purpose: Centralize IME state management to reduce application boilerplate and ensure consistent initialization.
Output: Updated `TextSystem` struct and initialization logic in `api.v`.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/40-ime-refinement/40-CONTEXT.md
@api.v
@composition.v
</context>

<tasks>

<task type="auto">
  <name>Add IME state to TextSystem</name>
  <files>api.v</files>
  <action>
    Modify `TextSystem` struct in `api.v`:
    - Add `pub mut composition CompositionState`
    - Add `pub mut dead_key DeadKeyState`

    Update `new_text_system` and `new_text_system_atlas_size`:
    - Initialize these fields (they have zero-value defaults, but ensure clarity).

    Add helper methods to `TextSystem`:
    - `reset_ime_state()`: resets both composition and dead key.
    - `is_composing() bool`: checks composition state.
  </action>
  <verify>
    Check syntax with `v fmt -w api.v`.
    Verify `TextSystem` struct has new fields.
  </verify>
  <done>
    TextSystem contains composition and dead_key fields.
  </done>
</task>

</tasks>

<verification>
Ensure `api.v` compiles and `TextSystem` struct is updated.
</verification>

<success_criteria>
- TextSystem manages composition and dead_key state.
- Existing code (if any using TextSystem) continues to compile (fields are added, not removing existing ones yet).
</success_criteria>

<output>
After completion, create `.planning/phases/40-ime-refinement/40-01-SUMMARY.md`
</output>
