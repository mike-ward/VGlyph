---
phase: 40-ime-refinement
plan: 03
type: execute
wave: 3
depends_on: ["40-02"]
files_modified: [examples/editor_demo.v]
autonomous: true
must_haves:
  truths:
    - "EditorState no longer has manual composition/dead_key fields"
    - "editor_demo.v uses StandardIMEHandler for both fields"
    - "editor_demo.v LOC is significantly reduced (removed redundant IME logic)"
  artifacts:
    - path: "examples/editor_demo.v"
      provides: "Simplified editor demo"
  key_links:
    - from: "EditorState"
      to: "StandardIMEHandler"
      via: "field handler"
---

<objective>
Update `editor_demo.v` to use `StandardIMEHandler`.

Purpose: Verify the new API and demonstrate significant reduction in boilerplate code for IME support.
Output: Refactored `editor_demo.v` using the refined IME API.
</objective>

<execution_context>
@/Users/mike/.gemini/get-shit-done/workflows/execute-plan.md
@/Users/mike/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/40-ime-refinement/40-CONTEXT.md
@.planning/phases/40-ime-refinement/40-01-SUMMARY.md
@.planning/phases/40-ime-refinement/40-02-SUMMARY.md
@examples/editor_demo.v
</context>

<tasks>

<task type="auto">
  <name>Refactor Editor Demo State</name>
  <files>examples/editor_demo.v</files>
  <action>
    - Remove `composition` and `dead_key` fields from `EditorState`.
    - Add `handler1` and `handler2` fields of type `vglyph.StandardIMEHandler`.
    - Update `init` to initialize these handlers with appropriate callbacks:
      - `on_commit`: points to functions that perform text insertion/undo recording.
      - `on_update`: empty (just triggers redraw/re-layout if needed, though `ts.draw_text` already handles preedit).
      - `get_layout`: returns `state.layout` or `state.layout2`.
      - `get_offset`: returns `(50, 50)` or `(430, 50)`.
    - Update `event` handler:
      - Replace `state.composition.is_composing()` calls with `state.ts.is_composing()`.
      - Use `state.ts.composition.commit()` for manual commit on click.
    - Update `frame` handler:
      - Use `state.ts.composition` for `draw_composition` and preedit rendering logic.
  </action>
  <verify>
    Verify `editor_demo.v` compiles.
  </verify>
  <done>
    EditorState is refactored to use TextSystem's managed IME state.
  </done>
</task>

<task type="auto">
  <name>Replace IME Callbacks</name>
  <files>examples/editor_demo.v</files>
  <action>
    - Remove the many `ime_on_*` and `ime_on_*2` functions (around 100+ LOC total).
    - In `vglyph.ime_overlay_register_callbacks`, pass the `vglyph.ime_standard_*` functions and `&state.handler1` / `&state.handler2` as user_data.
    - Remove the "global IME" callbacks (`ime_marked_text`, etc.) or refactor them to also use `StandardIMEHandler` if desired.
  </action>
  <verify>
    Verify `editor_demo.v` compiles and runs.
    Test typing and IME in both fields.
  </verify>
  <done>
    Redundant boilerplate removed from editor_demo.v.
  </done>
</task>

</tasks>

<verification>
Run `v run examples/editor_demo.v` and verify:
1. Normal typing works.
2. Dead keys (Option+e, e) work.
3. IME (Japanese/Chinese) works in both fields.
4. Clicking between fields commits IME properly.
</verification>

<success_criteria>
- editor_demo.v code size reduced.
- IME functionality preserved or improved (due to centralized validation).
- No regressions in multi-field focus handling.
</success_criteria>

<output>
After completion, create `.planning/phases/40-ime-refinement/40-03-SUMMARY.md`
</output>
