---
phase: 39-ime-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [ime_bridge_macos.m, ime_overlay_darwin.m]
autonomous: true
must_haves:
  truths:
    - "Native bridge checks for nil strings before processing"
    - "setMarkedText validates selectedRange before casting"
    - "Coordinate conversion logic is documented identically in both files"
  artifacts:
    - path: "ime_bridge_macos.m"
      provides: "Safe global IME bridge"
    - path: "ime_overlay_darwin.m"
      provides: "Safe overlay IME bridge"
---

<objective>
Improve the macOS native side implementation of IME.
This plan adds null checks, range validation, and consistent documentation for coordinate conversion.
</objective>

<execution_context>
@/Users/mike/.agent/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/39-ime-polish/39-CONTEXT.md
@ime_bridge_macos.m
@ime_overlay_darwin.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nil checks to ime_bridge_macos.m</name>
  <files>ime_bridge_macos.m</files>
  <action>
    - In `vglyph_insertText`: Check if `string` is nil before use. If nil, return early.
    - In `insertText:replacementRange:`: Check if `string` (or the extracted `text` from AttributedString) is nil.
    - In `setMarkedText:selectedRange:replacementRange:`: Check if `text` is nil or length 0 properly.
  </action>
  <verify>
    Verify code checks for nil.
  </verify>
  <done>
    ime_bridge_macos.m handles nil strings gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add validation to ime_overlay_darwin.m</name>
  <files>ime_overlay_darwin.m</files>
  <action>
    - In `setMarkedText`:
      - Check if `string` is nil.
      - Validate `selectedRange.location` against `text.length` before casting to `int`.
      - If out of bounds, clamp it or handle gracefully (e.g., set to end of text).
    - In `insertText`: Check if `string` is nil.
  </action>
  <verify>
    Verify validation logic is present.
  </verify>
  <done>
    ime_overlay_darwin.m validates input ranges and strings.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document coordinate conversion logic</name>
  <files>ime_bridge_macos.m, ime_overlay_darwin.m</files>
  <action>
    - In `firstRectForCharacterRange` (both files):
      - Update the coordinate conversion comments to be identical and clear.
      - Explicitly state: "Flip Y: VGlyph top-left origin -> macOS bottom-left origin".
      - Ensure the math is consistent: `viewHeight - y - height`.
  </action>
  <verify>
    Check both files contain the standardized comment.
  </verify>
  <done>
    Coordinate conversion logic is consistently documented.
  </done>
</task>

</tasks>

<verification>
Review the Objective-C files for the changes.
Compile the project to ensure no syntax errors: `v -d macos_ime_demo examples/editor_demo.v` (or just `v examples/editor_demo.v` on macOS).
</verification>

<success_criteria>
1. Nil checks present in both bridge files.
2. Range validation present in overlay bridge.
3. Coordinate conversion comments are identical.
</success_criteria>

<output>
After completion, create `.planning/phases/39-ime-polish/39-02-SUMMARY.md`
</output>
