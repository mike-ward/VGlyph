# Milestone v1.8: Overlay API Activation

**Status:** SHIPPED 2026-02-05
**Phases:** 33-34
**Total Plans:** 4

## Overview

Unblock per-overlay IME API by discovering MTKView from NSWindow,
enabling multi-field IME support. Switch editor_demo from global
callbacks to per-overlay API with global fallback preserved.

## Phases

### Phase 33: Overlay API Wiring

**Goal**: editor_demo uses per-overlay IME callbacks via MTKView
discovery, with global fallback intact and cross-platform compilation
preserved
**Depends on**: Phase 32 (v1.7 complete)
**Requirements**: IME-01, IME-02, IME-03, IME-04, IME-06
**Plans**: 2 plans

Plans:

- [x] 33-01: MTKView discovery + auto-create API + stubs
- [x] 33-02: editor_demo overlay wiring + two fields

**Success Criteria:**
1. Obj-C helper walks NSWindow view hierarchy and returns MTKView
   pointer (or null if not found)
2. editor_demo creates IME overlay from discovered MTKView via
   `vglyph_create_ime_overlay()` and receives IME events through
   per-overlay callbacks
3. When per-overlay path unavailable, global callback API still
   works identically to v1.7 behavior
4. `v build` succeeds on Linux without macOS overlay code compiling
   or linking

**Details:**
- MTKView discovery via recursive findViewByClass with depth limit 100
- Hard error (NULL return) when MTKView not found
- All parameters void* in public API (no macOS types leak)
- Lazy init in frame() (window not ready during sokol init)
- VGlyphIMEOverlayView overrides inputContext (category conflict)
- Standard interpretKeyEvents only (handleEvent breaks Korean)
- Always reclaim overlay focus on click (hitTest:nil steals it)
- _didInsertText flag prevents triple character echo

### Phase 34: Documentation & Verification

**Goal**: Project documentation reflects overlay API activation and
full regression passes
**Depends on**: Phase 33
**Requirements**: IME-05
**Plans**: 2 plans

Plans:

- [x] 34-01: Update all docs for overlay API
- [x] 34-02: Build verification + CJK IME regression

**Success Criteria:**
1. SECURITY.md documents Obj-C view hierarchy walk and its trust
   boundary
2. README reflects overlay API as the primary IME integration path
3. All CJK IME flows (Japanese, Chinese, Korean) work through
   overlay API in editor_demo

**Details:**
- SECURITY.md: NSView hierarchy discovery trust boundary diagram
- README: Overlay API code example as primary IME path
- IME-APPENDIX: CJK IME moved from "Future Work" to shipped
- EDITING: Overlay callback registration pattern
- API.md: All ime_overlay_* public functions documented
- All examples compile, all 6 test suites pass
- Japanese, Chinese, Korean IME verified through overlay

---

## Milestone Summary

**Key Decisions:**

- MTKView discovery via recursive findViewByClass (depth limit 100)
- Hard error on MTKView not found (no silent fallback)
- void* parameters in public API (no macOS types leak)
- Lazy frame() init (window not ready during sokol init)
- VGlyphIMEOverlayView overrides inputContext (category conflict fix)
- interpretKeyEvents only (handleEvent consumes Korean events)
- Overlay API as primary IME path in README
- Trust boundary documentation for NSView discovery

**Issues Resolved:**

- MTKView discovery unblocked per-overlay IME API
- inputContext category conflict (NSView category returned nil)
- Triple character echo (handleEvent + interpretKeyEvents + sokol)
- Korean IME event consumption via handleEvent
- makeFirstResponder during Metal render callback
- Click stealing first responder from overlay

**Issues Deferred:**

- Korean first-keypress macOS bug (upstream: Qt QTBUG-136128,
  Apple FB17460926, Alacritty #6942)

**Technical Debt Incurred:**

None.

---

_For current project status, see .planning/MILESTONES.md_
