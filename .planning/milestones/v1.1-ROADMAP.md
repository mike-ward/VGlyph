# Milestone v1.1: Fragile Area Hardening

**Status:** ✅ SHIPPED 2026-02-02
**Phases:** 4-7
**Total Plans:** 4

## Overview

Harden iterator lifecycle, attribute lists, FreeType state, and coordinate transforms. Focus on
documentation, debug-only validation guards, and consistent patterns across all fragile areas
identified in CONCERNS.md.

## Phases

### Phase 4: Layout Iteration

**Goal**: Safe iterator lifecycle prevents misuse and resource leaks
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:
- [x] 04-01: Iterator lifecycle docs and exhaustion guards

**Details:**
- Iterator lifecycle documentation at all 3 creation sites
- Debug-only exhaustion guards for run/char iteration loops
- Zero runtime overhead in release builds
- Requirements: ITER-01, ITER-02, ITER-03

### Phase 5: Attribute List

**Goal**: Attribute list ownership and lifecycle unambiguous
**Depends on**: Phase 4
**Plans**: 1 plan

Plans:
- [x] 05-01: AttrList ownership docs and debug leak counter

**Details:**
- Ownership boundaries documented at all 4 AttrList creation/unref sites
- Debug-only leak detection counter with check_attr_list_leaks() public function
- Double-free protection verified and documented
- Requirements: ATTR-01, ATTR-02, ATTR-03

### Phase 6: FreeType State

**Goal**: FreeType face state transitions validated and consistent
**Depends on**: Phase 5
**Plans**: 1 plan

Plans:
- [x] 06-01: FT state docs and debug prerequisite checks

**Details:**
- load→translate→render sequence documented at each FT operation
- Debug checks catch empty outline before FT_Outline_Translate
- Debug checks catch nil glyph slot before FT_Render_Glyph
- Fallback path explicitly documented as valid state sequence
- Requirements: FT-01, FT-02, FT-03

### Phase 7: Vertical Coords

**Goal**: Vertical text coordinate transforms clear and exhaustive
**Depends on**: Phase 6
**Plans**: 1 plan

Plans:
- [x] 07-01: Coord system docs, match expressions, orientation tests

**Details:**
- Coordinate system conventions documented at layout.v file top
- Inline transform formulas at glyph transform, run positioning, dimension override sites
- 8 orientation helper functions with _horizontal/_vertical suffix
- Match dispatch for compiler-verified orientation exhaustiveness
- 3 explicit orientation test cases
- Requirements: VERT-01, VERT-02, VERT-03

---

## Milestone Summary

**Decimal Phases:**
None - no urgent insertions required

**Key Decisions:**
- Debug-only guards: zero runtime overhead in release builds
- Exhaustion tracking: catches reuse bugs in development
- AttrList leak tracking: debug-only counter reusing Phase 4 pattern
- FT state validation: inline docs + debug guards catch invalid state transitions
- Match dispatch for orientation: compiler-verified enum exhaustiveness
- Helper function separation: _horizontal/_vertical suffix per CONTEXT.md

**Issues Resolved:**
- Iterator reuse after exhaustion now caught in debug builds
- AttrList ownership boundaries clarified with inline documentation
- FreeType state sequence confusion resolved with inline docs
- Vertical coordinate transform logic documented with formulas

**Issues Deferred:**
- Layout.destroy() not called in example code (minor, documented in audit)

**Technical Debt Incurred:**
None - all implementations clean with no TODO/FIXME/HACK comments

---

_For current project status, see .planning/ROADMAP.md_
