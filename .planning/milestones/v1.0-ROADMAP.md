# Milestone v1.0: Memory & Safety Hardening

**Status:** SHIPPED 2026-02-01
**Phases:** 1-3
**Total Plans:** 3

## Overview

Harden VGlyph's memory operations in 3 phases: first establish error propagation API, then add
memory safety checks that use that API, finally address layout.v pointer and string lifetime
issues. All work targets glyph_atlas.v and layout.v files identified in CONCERNS.md audit.

## Phases

### Phase 1: Error Propagation

**Goal**: GlyphAtlas API returns errors instead of asserting/crashing
**Depends on**: Nothing (first phase)
**Requirements**: ERR-01, ERR-02, ERR-03, ERR-04, ERR-05
**Success Criteria**:
  1. new_glyph_atlas returns `!GlyphAtlas` type
  2. Invalid dimensions (0, negative, overflow) return error instead of assert
  3. Allocation failure returns error instead of assert
  4. All callers handle GlyphAtlas error with `or` blocks
  5. Code compiles with `v -check-syntax`
**Plans**: 1 plan

Plans:
- [x] 01-01-PLAN.md - Convert new_glyph_atlas to error-returning API

**Details:**
- Converted new_glyph_atlas from assert-based to error-returning API
- Added dimension validation (w <= 0 || h <= 0)
- Added size overflow check (size <= 0 || size > max_i32)
- Added allocation failure check (img.data == nil)
- Updated both callers in renderer.v with or { panic(err) }

### Phase 2: Memory Safety

**Goal**: All vcalloc calls validated before dereference with error propagation
**Depends on**: Phase 1 (error propagation mechanism)
**Requirements**: MEM-01, MEM-02, MEM-03, MEM-04, MEM-05
**Success Criteria**:
  1. check_allocation_size helper validates overflow, max_i32, and 1GB limit
  2. grow() returns ! instead of logging and silently failing
  3. insert_bitmap propagates grow() errors to caller
  4. No log.error calls in grow() - errors returned silently
  5. Code compiles with `v -check-syntax`
**Plans**: 1 plan

Plans:
- [x] 02-01-PLAN.md - Add memory safety with error propagation to grow()

**Details:**
- Added check_allocation_size helper validating overflow, max_i32, and 1GB limit
- Converted grow() from silent failure (log+return) to error returns
- insert_bitmap now propagates grow() errors via ! operator

### Phase 3: Layout Safety

**Goal**: Pointer cast documented and validated; string lifetime safe
**Depends on**: Phase 2 (complete glyph_atlas.v first)
**Requirements**: PTR-01, PTR-02, STR-01, STR-02
**Success Criteria**:
  1. Unsafe pointer cast at line 156 has documentation comment explaining assumption
  2. Debug build has runtime validation for Pango pointer cast
  3. Object.id string is cloned before storing in Pango attribute
  4. Cloned string is freed when layout is destroyed
**Plans**: 1 plan

Plans:
- [x] 03-01-PLAN.md - Document pointer cast, fix string lifetime

**Details:**
- Added inline comment explaining PangoLayoutRun is typedef for PangoGlyphItem
- Added Pango API reference URL
- Added `$if debug` block with panic on null cast result
- Added `cloned_object_ids []string` field to Layout struct
- Added `Layout.destroy()` method that frees cloned strings
- Clones `obj.id` before passing to Pango shape attribute (skips empty strings)

---

## Milestone Summary

**Key Decisions:**

- Use `or { panic(err) }` in renderer constructors - atlas failure unrecoverable at init
- 1GB max allocation limit via const max_allocation_size
- Silent errors - no log.error, just return error
- Panic for debug null check on pointer cast
- Skip cloning empty strings for inline object IDs

**Issues Resolved:**

- Memory safety: vcalloc results now validated before dereference
- Error handling: Asserts replaced with error returns in GlyphAtlas constructor
- Pointer cast: Documented with API reference and debug validation
- String lifetime: Inline object IDs now properly cloned and freed

**Issues Deferred:**

- Layout.destroy() not called in examples (minor demo cleanup)

**Technical Debt Incurred:**

- Example code (inline_object_demo.v, rich_text_demo.v) should call Layout.destroy()

---

_For current project status, see .planning/ROADMAP.md_
